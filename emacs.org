#+TITLE: Pavel Iosad's Emacs init
#+AUTHOR: Pavel Iosad

* Configuration

** Scaffolding for use-package keywords

#+BEGIN_SRC emacs-lisp :noweb-ref init-before
  (use-package diminish)
  (use-package bind-key)
#+END_SRC

** El-patch

#+begin_src emacs-lisp :noweb-ref init-before
  (use-package el-patch)
#+end_src

** Pinentry

This sets up Emacs for GPG pinentry

#+BEGIN_SRC emacs-lisp :noweb-ref init-before
  (use-package pinentry
    :config
    (setq epa-pinentry-mode 'loopback)
          (pinentry-start))
#+END_SRC

** Keep =~/.emacs.d= clean

#+BEGIN_SRC emacs-lisp :noweb-ref init-before
  (use-package no-littering)
#+END_SRC

* Initialization
** Paths

Keep temporary files away from working directories 

#+BEGIN_SRC emacs-lisp :noweb-ref init-before
  (defvar conf/temp-directory "~/.emacs.temp.dir")
  (unless (file-exists-p conf/temp-directory)
    (mkdir conf/temp-directory))
#+END_SRC

Keep the =authinfo= file in the =.emacs.d= tree (as [[https://www.masteringemacs.org/article/keeping-secrets-in-emacs-gnupg-auth-sources][here]])

#+BEGIN_SRC emacs-lisp :noweb-ref init-before
  (setq auth-sources
        '((:source "~/.emacs.d/secrets/authinfo.gpg")
          (:source "~/.netrc.gpg")))
#+END_SRC

** System  specifics

#+BEGIN_SRC emacs-lisp :noweb-ref init-before
    (setq delete-by-moving-to-trash t
	  inhibit-compacting-font-caches nil)
  
    (use-package exec-path-from-shell
      :config
      (exec-path-from-shell-initialize))
  
    (pcase system-type
      ('darwin
       (setq mac-command-modifier 'super
	     mac-option-modifier 'meta
	     trash-directory "~/.Trash/")
       ;; BSD ls does not support --dired. Use GNU core-utils: brew install coreutils
       (when (executable-find "gls")
	 (setq insert-directory-program "gls"))
       (global-set-key (kbd "M-3")  ;; My Mac had # on Alt-3
		       (lambda () 
			 (interactive) 
			 (insert "#"))) )
      ('gnu/linux
       (setq trash-directory "~/.local/share/Trash/files/"
	     x-alt-keysym 'meta)))
#+END_SRC

** Temporary files

Put autosave and backup files into the directory we defined above

#+BEGIN_SRC emacs-lisp :noweb-ref init-after
  (setq backup-directory-alist (list (cons "."  (expand-file-name "saves/" conf/temp-directory)))
        backup-by-copying t      ; don't clobber symlinks
        delete-old-versions t
        kept-new-versions 6
        kept-old-versions 2
        version-control t)       ; use versioned backups
#+END_SRC

** Private
   
This configuration file is public, so we want to keep things like
passwords out of the way. Anything prefixed with ~private/~ comes
from that file. Take care to make sure this isn't publicly
accessible (=chmod 600= or --- better yet --- encryption)

#+BEGIN_SRC emacs-lisp :noweb-ref init-before
  (defvar conf/private-file (expand-file-name "private.el.gpg" user-emacs-directory))
  (load-library conf/private-file)
#+END_SRC

** Start the emacs server

Start the server if it isn't running

#+BEGIN_SRC emacs-lisp :noweb-ref init-before
  (use-package server
    :if window-system
    :config
    (unless (server-running-p)
      (server-start)))
#+END_SRC

** Custom

Set alternative location for =custom-set-variables= and =custom-set-faces=, 
to make sure Emacs doesn't dump them in your =init.el=.

#+BEGIN_SRC emacs-lisp :noweb-ref init-after
  (setq custom-file (expand-file-name "custom.el" user-emacs-directory))
  (load custom-file 'noerror)
  (put 'narrow-to-region 'disabled nil)
#+END_SRC

** Save place

Return to where we were

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package saveplace
    :init (save-place-mode 1))
#+END_SRC

** Auto revert

Update buffers if files have been changed on disk.

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (global-auto-revert-mode 1)
  (add-hook 'dired-mode-hook 'auto-revert-mode)
#+END_SRC

** Show file truenames

Don't show symlinked filenames

#+begin_src emacs-lisp :noweb-ref init
  (setq find-file-visit-truename t)
#+end_src

** Colorize in Emacs buffers

#+begin_src emacs-lisp :noweb-ref init
  (use-package ansi-color :straight nil)

  (defun endless/colorize-compilation ()
    "Colorize from `compilation-filter-start' to `point'."
    (let ((inhibit-read-only t))
      (ansi-color-apply-on-region
       compilation-filter-start (point))))

  (add-hook 'compilation-filter-hook
            #'endless/colorize-compilation)
#+end_src
* Appearance
** Dashboard

#+BEGIN_SRC emacs-lisp :noweb-ref appearance
  (use-package dashboard
    :config
    (dashboard-setup-startup-hook)
    (setq initial-buffer-choice (lambda () (get-buffer "*dashboard*"))
          dashboard-items '((recents . 5)
                            (projects . 5))
          dashboard-set-heading-icons t
          dashboard-set-file-icons t))
#+END_SRC

** Mode-line

Some packages to fix the mode-line

#+begin_src emacs-lisp :noweb-ref appearance
  (use-package minions
    :after doom-modeline
    :config
    (minions-mode 1)
    (setq minions-direct '(wc-goal-mode)))
  
  (use-package doom-modeline
    :init
    (doom-modeline-mode 1)
    :config
    (custom-set-faces
     '(mode-line ((t (:family "Castoro" :height 1.0))))
     '(mode-line-inactive ((t (:family "Castoro" :height 1.0)))))
    (setq doom-modeline-height 1
          doom-modeline-icon (display-graphic-p)
          doom-modeline-major-mode-icon t
          doom-modeline-major-mode-color-icon t
          doom-modeline-unicode-fallback t
          doom-modeline-enable-word-count t
          doom-modeline-enable-word-count-modes '(markdown-mode org-mode latex-mode)
          doom-modeline-buffer-encoding nil
          doom-modeline-minor-modes t
          doom-modeline-indent-info nil
          doom-modeline-workspace-name t
          doom-modeline-modal-icon t
          doom-modeline-mu4e t))
    #+end_src

** Unneeded chrome

We don't need scroll bars or tool bars, or indeed menus

#+BEGIN_SRC emacs-lisp :noweb-ref appearance
  (when (fboundp 'tool-bar-mode) 
    (tool-bar-mode -1))
  (when (fboundp 'scroll-bar-mode) 
    (scroll-bar-mode -1))
  (when (fboundp 'menu-bar-mode)
    (menu-bar-mode -1))
#+END_SRC

** COMMENT Diminish modes

Diminish some modes that are always on and which serve no purpose in the mode-line. Not needed with minions?

#+BEGIN_SRC emacs-lisp :noweb-ref init-after
(diminish 'auto-revert-mode)
(diminish 'evil-goggles-mode)
#+END_SRC

** Theme

Load some additional themes

#+begin_src emacs-lisp :noweb-ref appearance
  (use-package parchment-theme)
  (use-package mindre-theme
    :straight (:host github :repo "erikbackman/mindre-theme")
    :config
    (setq mindre-use-more-bold nil
          mindre-use-faded-lisp-parens t))

#+end_src

This sets the colours of the background and fonts.

#+BEGIN_SRC emacs-lisp :noweb-ref appearance 
  (setq my-theme 'doom-dracula)

  (defun load-my-theme (frame)
    (select-frame frame)
    (load-theme my-theme t))

  (use-package doom-themes
    :config
    (doom-themes-org-config))

  (if (daemonp)
      (add-hook 'after-make-frame-functions #'load-my-theme)
    (load-theme my-theme t))
#+END_SRC

*** COMMENT Modus themes

#+begin_src elisp :noweb-ref appearance
  (use-package modus-themes
   :init
   (setq modus-themes-italic-constructs t
         modus-themes-bold-constructs nil
         modus-themes-region '(bg-only no-extend)
         modus-themes-mixed-fonts t
         modus-themes-completions 'moderate
         modus-themes-org-blocks 'tinted-background)
   (modus-themes-load-themes)
   :config
   ;; Load the theme of your choice:
   (modus-themes-load-vivendi))
#+end_src

** Fonts

Set up the actual fonts to use

#+BEGIN_SRC emacs-lisp :noweb-ref appearance
  (set-fontset-font "fontset-default" 'georgian "Noto Sans Georgian-semibold-normal")
  (set-fontset-font "fontset-default" 'ethiopic "Noto Serif Ethiopic")
  (set-fontset-font "fontset-default" 'phoenician "Noto Sans Phoenician")
  (set-fontset-font "fontset-default" 'hebrew "Noto Sans Hebrew")
  (set-fontset-font "fontset-default" 'syriac "Serto Batnan-22")
  (setq buffer-face-mode-face '(:family "Iosevka Fixed SS09"))
  (set-face-attribute 'fixed-pitch nil :family "Iosevka SS09" :weight (if (eq system-type 'darwin) 'medium 'medium) :height 170)
  (set-face-attribute 'default nil :family "Iosevka SS09" :weight (if (eq system-type 'darwin) 'medium 'light) :height 170)
  (set-face-attribute 'variable-pitch nil :family (if (eq system-type 'darwin)
                                                      "Castoro"
                                                    "Spectral") :height
                                                    (if (eq system-type 'darwin)
                                                        180
                                                      160) :weight 'medium)
#+END_SRC

Allow mixing fixed and variable pitch.

#+begin_src emacs-lisp :noweb-ref appearance
      (use-package mixed-pitch
        :config
        (setq mixed-pitch-set-height t))
#+end_src

** Misc

Highlight the current line: not everyone's cup of tea, of course

#+BEGIN_SRC emacs-lisp :noweb-ref appearance
(global-hl-line-mode 0)
#+END_SRC

When possible, automatically scroll so that the cursor is in the 
middle of the window

#+BEGIN_SRC emacs-lisp :noweb-ref appearance
  (use-package centered-cursor-mode
    :diminish centered-cursor-mode
    :config
    (global-centered-cursor-mode 1)
    (setq ccm-recenter-at-end-of-file t))
#+END_SRC

This is to prevent emacs from getting in your way when run from 
the terminal

#+BEGIN_SRC emacs-lisp :noweb-ref appearance
  (defun conf/after-make-frame (frame)
    (unless (display-graphic-p frame)
      (when (fboundp 'menu-bar-mode) 
        (menu-bar-mode -1))
      (set-face-background 'default "dummy-color" frame)))

  (add-hook 'after-make-frame 'conf/after-make-frame)
#+END_SRC

No need for the bell

#+BEGIN_SRC emacs-lisp :noweb-ref appearance
(setq ring-bell-function 'ignore)
#+END_SRC

Use colours in the shell

#+BEGIN_SRC emacs-lisp :noweb-ref appearance
(add-hook 'shell-mode-hook 'ansi-color-for-comint-mode-on)
#+END_SRC

Never type out 'yes' or 'no'.

#+BEGIN_SRC emacs-lisp :noweb-ref appearance
(defalias 'yes-or-no-p 'y-or-n-p)
#+END_SRC

** Window title

We want that to be informative too

#+BEGIN_SRC emacs-lisp :noweb-ref appearance
  (setq frame-title-format
        '("emacs@" (:eval (system-name)) ": "(:eval (if (buffer-file-name)
                                                        (abbreviate-file-name (buffer-file-name))
                                                      "%b")) " [%*]"))

#+END_SRC

** Parentheses

Rainbow-Delimiters is nice to show matching parentheses.  This is
useful not just for Lisp but also for all sorts of nested structures,
like in =forest= trees.

#+BEGIN_SRC emacs-lisp :noweb-ref appearance
  (use-package rainbow-delimiters
    :commands rainbow-delimiters-mode
    :hook
    ((LaTeX-mode-hook . rainbow-delimiters-mode)
     (lisp-mode-hook . rainbow-delimiters-mode)
     (emacs-lisp-mode-hook . rainbow-delimiters-mode)))
#+END_SRC

Highlight matching parentheses, braces, etc.

#+BEGIN_SRC emacs-lisp :noweb-ref appearance
(show-paren-mode t)
#+END_SRC

Prism for colour-coding embedding in code. 

#+BEGIN_SRC emacs-lisp :noweb-ref appearance
  (use-package prism
    :hook
    (emacs-lisp-mode . prism-mode)
    (lisp-mode . prism-mode) 
    (ess-mode . prism-mode)
    (python-mode . prism-whitespace-mode))
#+END_SRC

** Dimmer

Makes it clearer which buffer is active

#+BEGIN_SRC emacs-lisp :noweb-ref appearance
  (use-package dimmer
    :custom (dimmer-fraction 0.4)
    :config
    (dimmer-configure-which-key)
    (dimmer-configure-helm)
    (dimmer-configure-hydra)
    (dimmer-configure-magit)
    (dimmer-mode 1))
#+END_SRC

** COMMENT Zoom windows

Sensible window layouts. These currently don't seem to work well for me.

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package zoom
    :config
    (defun zoom-size-callback ()
      (cond ((> (frame-pixel-width) 1280) '(90 . 0.75))
            (t                            '(0.5 . 0.5))))
    (zoom-mode 1)
    (custom-set-variables
     '(zoom-size 'zoom-size-callback)))

  (use-package edwina
    :config
    ;; (setq display-buffer-base-action '(display-buffer-below-selected))
    (edwina-mode 1))

  (use-package golden
    :straight (:repo "https://git.sr.ht/~wklew/golden"))
#+END_SRC

* General editing
** Encodings

Use UTF-8 encoding wherever possible:

#+BEGIN_SRC emacs-lisp :noweb-ref editing
(set-default-coding-systems 'utf-8-unix)
(set-terminal-coding-system 'utf-8-unix)
(set-keyboard-coding-system 'utf-8-unix)
(prefer-coding-system 'utf-8-unix)
(setenv "LANG" "en_GB.UTF-8")
(setenv "LC_ALL" "en_GB.UTF-8")
(setenv "LC_CTYPE" "en_GB.UTF-8")
(setenv "PYTHONIOENCODING" "utf-8")
#+END_SRC

Even so, ~ansi-term~ doesn't obey:

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (defadvice ansi-term (after advise-ansi-term-coding-system)
    (set-process-coding-system 'utf-8-unix 'utf-8-unix))
  (ad-activate 'ansi-term)
#+END_SRC

** Spelling

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package flyspell
    :hook
    ((text-mode-hook . flyspell-mode)
     (prog-mode-hook . flyspell-mode))
    :config
    (setq ispell-program-name (if (eq system-type 'darwin)
                                  "/opt/homebrew/bin/aspell"
                                "/usr/bin/aspell")
          ispell-really-aspell t)
    (add-to-list 'ispell-dictionary-alist
                 '("nynorsk"
                   "[[:alpha:]]"
                   "[^[:alpha:]]"
                   "[']" t ("-C" "-d" "nynorsk") nil utf-8))
    (add-to-list 'ispell-dictionary-alist
                 '("gaidhlig"
                   "[[:alpha:]]"
                   "[^[:alpha:]]"
                   "[']" t ("-C" "-d" "gd") nil utf-8))
    (add-to-list 'ispell-dictionary-alist
                 '("gaeilge"
                   "[[:alpha:]]"
                   "[^[:alpha:]]"
                   "[']" t ("-C" "-d" "ga") nil utf-8))
    (add-to-list 'ispell-dictionary-alist
                 '("bokmal"
                   "[[:alpha:]]"
                   "[^[:alpha:]]"
                   "[']" t ("-C" "-d" "nb") nil utf-8))
    (add-to-list 'ispell-dictionary-alist
                 '("cymraeg"
                   "[[:alpha:]]"
                   "[^[:alpha:]]"
                   "[']" t ("-C" "-d" "cy") nil utf-8))
  
    (setq-default flyspell-default-dictionary "en_GB-ize-w_accents"))                 
#+END_SRC

** Syntax checking

Use [[https://github.com/flycheck/flycheck][Flycheck]] to validate syntax on the fly.

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package flycheck
    :init (global-flycheck-mode)
    :diminish
    flycheck-mode
    :config 
    (setq-default flycheck-disabled-checkers '(html-tidy emacs-lisp-checkdoc tex-chktex tex-lacheck))
    (setq flycheck-highlighting-mode 'lines
          flycheck-check-syntax-automatically '(save idle-change mode-enabled)
          flycheck-idle-change-delay 2))
#+END_SRC

** Version control

Magit provides featureful Git integration.

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package magit
    :commands (magit-status magit-diff magit-log magit-blame-mode)
    :bind ("C-x g" . magit-status)
    :init (setq magit-last-seen-setup-instructions "1.4.0")
    :config
    (add-hook 'magit-process-find-password-functions
              'magit-process-password-auth-source))

  (use-package magithub
    :after magit
    :config
    (magithub-feature-autoinject t)
    (setq magithub-clone-default-directory "~/src"))

  (use-package forge
    :after magit
    :config
    (add-to-list 'forge-alist '("git.ecdf.ed.ac.uk" "git.ecdf.ed.ac.uk/api/v4/" "UoE GitLab" forge-gitlab-repository)))

  (use-package abridge-diff
    :after magit
    :diminish abridge-diff-mode
    :init
    (abridge-diff-mode 1))

  (use-package git-time-machine)

  (use-package git-auto-commit-mode)
#+END_SRC

** Visual regexp

#+begin_src emacs-lisp :noweb-ref editing
  (use-package visual-regexp)

  (use-package visual-regexp-steroids
    :bind
    ((("C-c r" . vr/replace) 
      ("C-c q" . vr/query-replace)
      ("C-c M-r" . vr/isearch-backward)
      ("C-c M-s" . vr/isearch-forward)))
    :config
    (setq vr/command-python
          (let ((python-command (if (eq system-type 'darwin)
                                    "/opt/homebrew/bin/python3"
                                  "python")))
            (format "%s %s" python-command (expand-file-name "straight/build/visual-regexp-steroids/regexp.py" user-emacs-directory)))))
#+end_src

** Programming modes
*** Emacs Lisp

This sets up ~eldoc~.

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package eldoc
    :commands
    turn-on-eldoc-mode
    :diminish
    eldoc-mode
    :hook
    ((emacs-lisp-mode-hook . turn-on-eldoc-mode)))
#+END_SRC

*** Web

Web mode provides, among other features, syntax highlighting for
Javascript and CSS embedded in HTML as well as highlighting for
various templating languages.

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package web-mode
    :mode (("\\.html?\\'" . web-mode)
           ("\\.css\\'" . web-mode))
    :config
    (setq web-mode-enable-auto-pairing t
          web-mode-enable-engine-detection t
          web-mode-engines-alist
          '(("jinja2" . "\\.html?\\'")))
    :init
    (add-hook 'web-mode-hook (lambda ()
                               (set-fill-column 120))))
#+END_SRC

*** Python

Basic python setup

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package python
    :mode ("\\.py\\'" . python-mode)
    :config
    (setq-default python-shell-interpreter (if (eq system-type 'darwin)
                                               "/opt/homebrew/bin/python3"
                                             "/usr/bin/python")))
#+END_SRC

Activate relevant virtualenvs

#+begin_src emacs-lisp :noweb-ref editing
  (use-package auto-virtualenvwrapper
    :config
    (add-hook 'python-mode-hook #'auto-virtualenvwrapper-activate))
#+end_src

*** Common Lisp

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package slime
    :mode ("\\.lisp\\'" . lisp-mode)
    :init
    (setq slime-net-coding-system 'utf-8-unix
          inferior-lisp-program "sbcl")
    (add-to-list 'slime-contribs 'slime-fancy)
    (add-to-list 'slime-contribs 'slime-repl))
#+END_SRC

*** R
**** Basic ESS setup

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package ess-site
    :straight ess
    :mode ("\\.R\\'" . ess-r-mode)
    :commands R
    :config
    (use-package ess-smart-underscore)
  
    (use-package ess-rutils)  
  
    (setq ess-eval-visibly 'nowait
          ess-style 'RStudio)
  
    (defun tex-Rnw-check (name)
      "When opening a .tex file, check to make sure there isn't a
  corresponding .Rnw available, to make sure we don't try to edit
  the wrong file."
      (when (and (bufferp name)
                 (buffer-file-name name))
        (let* ((rnw-file (format "%s.Rnw" (file-name-sans-extension (buffer-file-name name)))))
          (when (and (equal (file-name-extension (buffer-file-name name)) "tex")
                     (member rnw-file (mapcar #'buffer-file-name (buffer-list))))
            (if (yes-or-no-p "You are trying to open a .tex file, but the corresponding .Rnw file seems to be open. Are you sure?")
                name
              (find-buffer-visiting rnw-file))))))
  
    (defadvice switch-to-buffer (around noweb-check activate)
      (let ((buffer-or-name (or (tex-Rnw-check (ad-get-arg 0))
                                (ad-get-arg 0))))
        ad-do-it))
    (ad-update 'switch-to-buffer)
  
    (add-hook 'LaTeX-mode-hook
              (defun my-Rnw-mode-hook ()
                "Add commands to AUCTeX's \\[TeX-command-list]."
                (unless (and (featurep 'tex-site) (featurep 'tex))
                  (error "AUCTeX does not seem to be loaded"))
                (add-to-list 'TeX-command-list
                             '("LaTeXKnit" "%l %(mode) %s"
                               TeX-run-TeX nil (latex-mode) :help
                               "Run LaTeX after Knit") t)
                (dolist (suffix '("nw" "Snw" "Rnw"))
                  (add-to-list 'TeX-file-extensions suffix))))
  
    (add-hook 'R-mode-hook
              (defun my-R-mode-hook ()
                (company-mode)
                (local-set-key (kbd "TAB") 'company-complete))))
  
  (use-package ess-smart-equals
    :disabled t
    :init   (setq ess-smart-equals-extra-ops '(brace paren))
    :after  (:any ess-r-mode inferior-ess-r-mode ess-r-transcript-mode)
    :config (ess-smart-equals-activate))
  
  (use-package ess-view-data
    :after ess-site
    :bind
    (:map ess-r-mode-map
          ("C-c _" . ess-view-data-print))
    (:map inferior-ess-r-mode-map
          ("C-c _" . ess-view-data-print)))
#+END_SRC

**** Polymode

This is the recommended solution for Rmarkdown files.

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package polymode           ; ESS with polymode
    :mode (("\\.[Rr]md\\'" . poly-markdown+r-mode)
	   ("\\.[Rr]nw\\'" . poly-noweb+r-mode))
    :config
    (setq-default 
     pm-weaver "knitR-ESS"
     polymode-weaver-output-file-format "%s"
     polymode-exporter-output-file-format "%s"))

  (use-package poly-R
    :after polymode ess-site)

  (use-package poly-markdown
    :after polymode markdown-mode)

  (use-package poly-noweb
    :after polymode)
#+END_SRC

**** Quarto

Mode for [[https://quarto.org][quarto]] interaction, built on [[*Polymode][polymode]]

#+begin_src emacs-lisp :noweb-ref editing
    (use-package quarto-mode)
#+end_src
*** Stan

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package stan-mode
    :mode "\\.stan\\'"
    :config
    (use-package stan-snippets
      :config (add-hook 'stan-mode-hook 'yas-minor-mode)))
#+END_SRC

*** LSP mode

Language server protocol setup

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (setq lsp-keymap-prefix "C-c M-l")

  (use-package lsp-mode
    :init
    (setq gc-cons-threshold 100000000)
    (setq read-process-output-max (* 1024 1024))
    :hook ((R-mode . lsp)
           ;; (tex-mode . lsp)
           ;; (latex-mode . lsp)
           ;; (LaTeX-mode . lsp)
           ;; (bibtex-mode . lsp)
           (python-mode . lsp)
           ;; (LaTeX-mode . lsp-headerline-breadcrumb-mode)
           )
    :commands lsp
    :config
    (add-hook 'lsp-mode-hook 'lsp-enable-which-key-integration))

  ;; optionally
  (use-package lsp-ui :commands lsp-ui-mode)
  (use-package helm-lsp :commands helm-lsp-workspace-symbol)
  (use-package lsp-treemacs :commands lsp-treemacs-errors-list)

  (use-package lsp-latex
    :disabled t
    :commands lsp
    :bind (:map LaTeX-mode-map
                (("C-c C-'" . lsp-ui-imenu)))
    :config
    (setq lsp-latex-build-args
          (cons "-lualatex" (remove "-pdf" lsp-latex-build-args))))

  (use-package which-key
    :diminish which-key-mode
    :config
    (which-key-mode))
#+END_SRC

*** Yaml mode

#+begin_src emacs-lisp :noweb-ref editing
  (use-package yaml-mode)
#+end_src

*** Lua mode

#+begin_src emacs-lisp :noweb-ref editing
  (use-package lua-mode
    :mode "\\.lua\\'")
#+end_src

** Keyboard layout

Tell Emacs that I have a UK keyboard.

#+BEGIN_SRC emacs-lisp :noweb-ref editing
(quail-set-keyboard-layout "pc105-uk")
#+END_SRC

** Narrow-indirect

Edit portions of file in indirect buffers, overwriting regular narrowing keybindings

#+begin_src emacs-lisp :noweb-ref editing
  (use-package narrow-indirect
    :bind (:map narrow-map
                ("C-x n d" . ni-narrow-to-defun-indirect-other-window)
                ("C-x n n" . ni-narrow-to-region-indirect-other-window)
                ("C-x n p" . ni-narrow-to-page-indirect-other-window)))
#+end_src
* Working with text
** General

We probably want our lines wrapped when we're writing

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (diminish 'visual-line-mode)
  (add-hook 'text-mode-hook 
            (lambda ()
              (visual-line-mode 1)))

  ;; from http://endlessparentheses.com/fill-and-unfill-paragraphs-with-a-single-key.html
  (defun endless/fill-or-unfill ()
    "Like `fill-paragraph', but unfill if used twice."
    (interactive)
    (let ((fill-column
           (if (eq last-command 'endless/fill-or-unfill)
               (progn (setq this-command nil)
                      (point-max))
             fill-column)))
      (call-interactively #'fill-paragraph)))

  (global-set-key [remap fill-paragraph]
                  #'endless/fill-or-unfill)
#+END_SRC


Hippie-expand is a nice autocompletion engine

#+BEGIN_SRC emacs-lisp :noweb-ref editing
(global-set-key (kbd "M-/") 'hippie-expand)
#+END_SRC

*** Writing environment improvements

Narrower margins to focus when writing

#+begin_src emacs-lisp :noweb-ref editing
  (use-package olivetti
    :config
    (setq olivetti-body-width (if (eq system-type 'darwin)
                                          88
                                        75))
    (add-hook 'olivetti-mode-hook
              (defun my-olivetti-mode-hook ()
                (if olivetti-mode (mixed-pitch-mode 1)
                  (mixed-pitch-mode 'toggle)))))
#+end_src

*** Palimpsest-mode

Easily save sentences elsewhere for reuse

#+begin_src emacs-lisp :noweb-ref editing
  (use-package palimpsest-mode
    :straight (:host github :repo "danielsz/Palimpsest")
    :hook (text-mode . palimpsest-mode)
    :custom
    ((palimpsest-send-bottom "C-c C-x C-r")
     (palimpsest-send-top "C-c C-x C-s")
     (palimpsest-trash-key "C-c C-x C-q")))
#+end_src

*** COMMENT Imenu-list

Sidebar contents

#+begin_src emacs-lisp :noweb-ref editing
  (use-package imenu-list
    :bind ("C-c C-'" . imenu-list-smart-toggle)
    :config
    (setq imenu-list-focus-after-activation t))
#+end_src
** Smartparens

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package smartparens-config
    :straight (:host github :repo "Fuco1/smartparens")
    :diminish smartparens-mode
    :config
    (show-smartparens-global-mode t)
    (add-hook 'prog-mode-hook 'turn-on-smartparens-strict-mode)
    (add-hook 'markdown-mode-hook 'turn-on-smartparens-strict-mode)
    (add-hook 'LaTeX-mode-hook 'turn-on-smartparens-strict-mode)
    (sp-local-pair 'LaTeX-mode "'" "'" :actions nil)
    (sp-local-pair 'markdown-mode "'" "'")
    (bind-keys :map smartparens-mode-map
               ("C-M-a" . sp-beginning-of-sexp)
               ("C-M-e" . sp-end-of-sexp)
               ("C-<down>" . sp-down-sexp)
               ("C-<up>"   . sp-up-sexp)
               ("M-<down>" . sp-backward-down-sexp)
               ("M-<up>"   . sp-backward-up-sexp)
               ("C-M-f" . sp-forward-sexp)
               ("C-M-b" . sp-backward-sexp)
               ("C-M-n" . sp-next-sexp)
               ("C-M-p" . sp-previous-sexp)
               ("C-S-f" . sp-forward-symbol)
               ("C-S-b" . sp-backward-symbol)
               ("M-<right>" . sp-forward-slurp-sexp)
               ("C-<right>" . sp-forward-barf-sexp)
               ("M-<left>"  . sp-backward-slurp-sexp)
               ("C-<left>"  . sp-backward-barf-sexp)
               ("C-M-t" . sp-transpose-sexp)
               ("C-M-k" . sp-kill-sexp)
               ("C-k"   . sp-kill-hybrid-sexp)
               ("M-k"   . sp-backward-kill-sexp)
               ("C-M-w" . sp-copy-sexp)
               ("C-M-d" . delete-sexp)
               ("M-<backspace>" . backward-kill-word)
               ("C-<backspace>" . sp-backward-kill-word)
               ([remap sp-backward-kill-word] . backward-kill-word)
               ("M-[" . sp-backward-unwrap-sexp)
               ("M-]" . sp-unwrap-sexp)
               ("C-x C-t" . sp-transpose-hybrid-sexp))
    (use-package evil-smartparens
      :config
      (add-hook 'LaTeX-mode-hook #'evil-smartparens-mode)
      (add-hook 'prog-mode-hook #'evil-smartparens-mode)))
#+END_SRC

** LaTeX
   
#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package tex-site
    :straight auctex
    :mode ("\\.tex\\'" . LaTeX-mode)
    :commands (LaTeX-mode latex-mode plain-tex-mode)
    :init
    (defun insert-feature (arg feature value)
      "This just saves some typing, feel free to comment
                       out."
      (interactive "P\nMFeature: \nMValue: ")
      (insert (format
               (if arg
                   "\\mbox{\\ensuremath{%s}%s}"
                 "\\mbox{[\\ensuremath{%s}%s]}")
               value feature)))
    (setq-default my-alternative-input-method "ipa-x-sampa")

    (defun LaTeX-narrow-to-subtree ()
      "Make text outside current section invisible."
      (interactive)
      (save-excursion
        (widen)
        (outline-mark-subtree)
        (ni-narrow-to-region-indirect-other-window (point) (mark) 0)
        (when wc-goal-mode
          (wc-goal-reset))
        (setq deactivate-mark t)))

    :config
    (add-hook 'LaTeX-mode-hook
              (defun my-LaTeX-mode-hook ()
                (setq font-latex-match-function-keywords '(("ipa" "{")
                                                           ("twe" "{{{")
                                                           ("mbi" "{{")
                                                           ("x" "[{{")
                                                           ("xt" "[{{")
                                                           ("xo" "[{{")
                                                           ("w" "[{{")
                                                           ("xr" "[{{") 
                                                           ("ox" "[{{{")
                                                           ("y" "[{")
                                                           ("yt" "[{")
                                                           ("yo" "[{")
                                                           ("yr" "[{")
                                                           ("featr" "{")
                                                           "ex" "pex" "pex~" "xe" "a")
                      TeX-parse-self t
                      TeX-auto-save t
                      TeX-electric-sub-and-superscript t
                      LaTeX-csquotes-close-quote "}"
                      LaTeX-csquotes-open-quote "\\enquote{"
                      TeX-outline-extra '(("\\\\printbibliography" 2))
                      TeX-source-correlate t
                      TeX-engine 'luatex) 
                (flyspell-mode)
                (TeX-fold-mode 1)
                ;; This activates the X-SAMPA layout, making
                ;; it accessible via C-\
                (set-input-method my-alternative-input-method)
                (toggle-input-method)
                (outline-minor-mode 1)
                (turn-on-reftex)
                (add-to-list 'LaTeX-font-list '(22 "\\ipa{" "}"))
                (TeX-source-correlate-mode 1)
                (add-to-list 'TeX-view-program-selection
                             '(output-pdf "PDF Tools"))
                (bind-keys :map LaTeX-mode-map
                           ("C-x n @" . LaTeX-narrow-to-subtree)
                           ("C-c f" . insert-feature)
                           ("C-c }" . LaTeX-close-environment)
                           ("C-c ]" . helm-bibtex))
                (add-hook 'TeX-after-compilation-finished-functions #'TeX-revert-document-buffer))))

  (use-package auctex-latexmk
    :disabled t
    :after tex-site
    :config
    (add-hook 'LaTeX-mode-hook
              (defun my-LaTeXMk-setup ()
                (auctex-latexmk-setup)
                (setq auctex-latexmk-inherit-TeX-PDF-mode t))))

  (use-package procress
    :disabled
    :straight (:host github :repo "haji-ali/procress")
    :commands tex-procress-mode
    :init
    (add-hook 'LaTeX-mode-hook 'tex-procress-mode)
    :config
    (procress-load-default-svg-images))

#+END_SRC

** Org-mode

Org-mode is very good for all sort of working with plain text, as
this file testifies. I use it as my calendar application, so most
of the settings are geared towards that. 

#+BEGIN_SRC emacs-lisp :noweb-ref org
  (setq main-agenda-file (expand-file-name (car private/org-files)))

  (defun find-main-agenda-file ()
    "This is just a shortcut to open the main agenda file. Change the
     path to that in your =private.el.gpg="
    (interactive) 
    (find-file main-agenda-file))
#+END_SRC

The following sets up Org-mode itself

#+BEGIN_SRC emacs-lisp :noweb-ref org
  (use-package org
    :bind
    ("C-c l" . org-store-link)
    ("C-c a" . org-agenda)
    ("C-c t" . org-capture)
    ;; ("C-x C-a C-w" . find-main-agenda-file)
    :config
    (eval-after-load "org"
      '(define-key org-mode-map (kbd "C-c ]") nil))
    (require 'org-inlinetask)
    (require 'org-habit)
    (setq org-log-done t
          org-use-property-inheritance t
          org-agenda-files private/org-files
          org-directory private/org-directory
          org-startup-indented t
          org-src-fontify-natively t
          org-icalendar-timezone "Europe/London"
          org-refile-targets '((org-agenda-files . (:maxlevel . 5))
                               (private/org-project-files . (:maxlevel . 5)))
          org-icalendar-use-deadline '(todo-due)
          org-agenda-window-setup 'current-window
          org-agenda-span 'week
          org-agenda-skip-scheduled-if-deadline-is-shown t
          org-agenda-skip-deadline-prewarning-if-scheduled 'pre-scheduled
          org-icalendar-alarm-time 15
          org-columns-default-format "%30ITEM %TODO %3PRIORITY %DEADLINE %20LOCATION"
          org-src-fontify-natively t
          org-clock-persist 'history
          org-clock-idle-time 10
          org-clock-x11idle-program-name "/usr/bin/xprintidle"
          org-hide-emphasis-markers t
          org-preview-latex-default-process 'imagemagick)
    (org-clock-persistence-insinuate)

    ; The following allows to export LaTeX code blocks in org-mode-export
    (org-babel-do-load-languages 'org-babel-load-languages
                                 '((latex . t)))
    (add-hook 'org-babel-after-execute-hook 'org-redisplay-inline-images)
    ; org-confirm-babel-evaluate can be set to t, but it's safer to do
    ; this on a file/directory basis

    (setq org-capture-templates '(("t" "todo" entry (file+headline main-agenda-file "Tasks") "* TODO %?\n%a")
                                  ("e" "event" entry (file+headline main-agenda-file "Events from email") "* %?\n%^{Date + time}T\n%a")))

    ;; The following sets up my LaTeX export preferences

    (with-eval-after-load 'ox-latex
      (add-to-list 'org-latex-classes
                   '("memoir-article" (f-read-text (expand-file-name "etc/ox-latex-preamble.txt" user-emacs-directory))
                     ("\\section{%s}" . "\\section*{%s}")
                     ("\\subsection{%s}" . "\\subsection*{%s}")
                     ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                     ("\\paragraph{%s}" . "\\paragraph*{%s}")))

      (setq org-latex-packages-alist
            '(("" "luatextra" t ("lualatex"))
              ("" "xltxtra" t ("xelatex"))
              ("AUTO" "babel" nil ("pdflatex" "lualatex"))
              ("AUTO" "polyglossia" nil ("xelatex"))
              ("" "expex" t)
              ("" "booktabs" nil)
              ("autostyle" "csquotes" nil)
              ("backend=biber,style=unified,mincrossrefs=50,maxcitenames=3,maxbibnames=50,useprefix=true,autolang=hyphen,parentracker=true,doi=false" "biblatex" nil)
              ("" "phonrule" nil)
              ("" "longtable" nil)
              ("" "hyphenat" nil)
              ("" "eqparbox" nil)
              ("" "cleveref" nil)
              ("activate={true, nocompatibility}, tracking" "microtype" nil ("pdflatex" "lualatex"))
              ("english, german" "selnolig" nil ("lualatex")))))

    (setq-default org-latex-compiler "lualatex"
                  org-latex-bib-compiler "biber"
                  org-latex-pdf-process
                  '("%latex -interaction nonstopmode -output-directory%o %f"
                    "%bib %b"
                    "%latex -interaction nonstopmode -output-directory %o %f")
                  org-export-with-toc nil))

  (add-hook 'org-mode-hook
            (defun my-org-mode-hook ()
              (local-set-key (kbd "C-c '") 'org-edit-src-code)))

  (defun my-clock-files ()
    (-distinct (append org-agenda-files private/org-project-files)))

  (use-package org-crypt
    :straight nil
    :config
    (org-crypt-use-before-save-magic)
    (setq org-tags-exclude-from-inheritance '("crypt")
          org-crypt-key nil))

  (use-package org-protocol
    :straight nil
    :config
    (mapcar (lambda (x)
              (add-to-list 'org-capture-templates x t))
          `(("p" "Protocol" entry (file+headline ,(concat org-directory "protocol-notes.org") "Inbox")
             "* %^{Title}\nSource: %u, %c\n #+BEGIN_QUOTE\n%i\n#+END_QUOTE\n\n\n%?")
            ("L" "Protocol Link" entry (file+headline ,(concat org-directory "protocol-notes.org") "Inbox")
             "* %? [[%:link][%:description]] \nCaptured On: %U"))))

  (use-package org-download
    :after org
    :config
    (setq org-download-screenshot-method "spectacle -br -o %s"
          org-download-method 'attach)
    :bind
    (:map org-mode-map
          (("s-Y" . org-download-screenshot)
           ("s-y" . org-download-yank)
           ("s-V" . org-download-clipboard))))

  (use-package org-appear
    :hook
    (org-mode . org-appear-mode))

  (use-package org-pandoc-import
    :straight (:host github
               :repo "tecosaur/org-pandoc-import"
               :files ("*.el" "filters" "preprocessors")))

  (use-package org-drill
    :config
    (require 'org-drill)
    (use-package org-drill-table))

  (use-package ox-pandoc
    :after org
    :config
    (setq org-pandoc-options
          `((standalone . t)
            (csl . "~/ownCloud/varia/unified-style-linguistics.csl")
            (filter . ,(substring (shell-command-to-string "which pandoc-crossref") 0 -1)))
          org-pandoc-options-for-docx
          '((citeproc . t)
            (number-sections . t))
          org-pandoc-menu-entry
          '((61 "to ms-pdf and open." org-pandoc-export-to-ms-pdf-and-open)
            (45 "to ms-pdf." org-pandoc-export-to-ms-pdf)
            (98 "to beamer-pdf and open." org-pandoc-export-to-beamer-pdf-and-open)
            (66 "to beamer-pdf." org-pandoc-export-to-beamer-pdf)
            (108 "to latex-pdf and open." org-pandoc-export-to-latex-pdf-and-open)
            (76 "to latex-pdf." org-pandoc-export-to-latex-pdf)
            (111 "to odt and open." org-pandoc-export-to-odt-and-open)
            (79 "to odt." org-pandoc-export-to-odt)
            (118 "to revealjs and open." org-pandoc-export-to-revealjs-and-open)
            (86 "as revealjs." org-pandoc-export-as-revealjs)
            (120 "to docx and open." org-pandoc-export-to-docx-and-open)
            (88 "to docx." org-pandoc-export-to-docx))))

  (use-package org-modern
    :after org
    :config
    (setq org-auto-align-tags nil
          org-tags-column 0
          org-catch-invisible-edits nil
          org-special-ctrl-a/e t
          org-pretty-entities t
          org-ellipsis "…"
          org-agenda-tags-column 0
          org-agenda-block-separator ?─
          org-agenda-time-grid
          '((daily today require-timed)
            (800 1000 1200 1400 1600 1800 2000)
            " ┄┄┄┄┄ " "┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄")
          org-agenda-current-time-string
          "⭠ now ─────────────────────────────────────────────────")
    (global-org-modern-mode))
#+END_SRC
  
** Markdown and pandoc

Markdown is a lightweight alternative to HTML. For me, the two main
uses are for websites (many site generators understand Markdown so
you don't have to write HTML) and conversions from Markdown to
other formats via [[http://johnmacfarlane.net/pandoc][pandoc]].

This bit loads markdown-mode and sets up various customizations.

#+BEGIN_SRC emacs-lisp :noweb-ref pandoc
  (use-package markdown-mode
    :mode ("\\.\\(m\\(ark\\)?down\\|md\\)$" . markdown-mode)
    :config
    (setq-default markdown-footnote-location 'immediately
                  markdown-enable-math t
                  markdown-hide-urls t
                  markdown-fontify-code-blocks-natively t)
    (add-hook 'markdown-mode-hook
              (defun my-markdown-mode-hook ()
                (flyspell-mode)
                (pandoc-mode)
                (typopunct-mode)
                (outline-minor-mode)
                (yas-minor-mode)))

    ;; Patch markdown-mode to understand pandoc's {=LANGUAGE} code
    ;; blocks

    (el-patch-defun markdown-code-block-lang (&optional pos-prop)
      "Return the language name for a GFM or tilde fenced code block.
  The beginning of the block may be described by POS-PROP,
  a cons of (pos . prop) giving the position and property
  at the beginning of the block."
      (or pos-prop
          (setq pos-prop
                (markdown-max-of-seq
                 #'car
                 (cl-remove-if
                  #'null
                  (cl-mapcar
                   #'markdown-find-previous-prop
                   (markdown-get-fenced-block-begin-properties))))))
      (when pos-prop
        (goto-char (car pos-prop))
        (set-match-data (get-text-property (point) (cdr pos-prop)))
        ;; Note: Hard-coded group number assumes tilde
        ;; and GFM fenced code regexp groups agree.
        (let ((begin (match-beginning 3))
              (end (match-end 3)))
          (when (and begin end)
            ;; Fix language strings beginning with periods, like ".ruby".
            (when (el-patch-swap
                    (eq (char-after begin) ?.)
                    (or (eq (char-after begin) ?.)
                        (eq (char-after begin) ?=)))
              (setq begin (1+ begin)))
            (buffer-substring-no-properties begin end)))))

    ;; patch markdown-narrow-to-subtree to use indirect buffers
    (el-patch-defun markdown-narrow-to-subtree ()
      "Narrow buffer to the current subtree."
      (interactive)
      (save-excursion
        (save-match-data
          ((el-patch-swap narrow-to-region ni-narrow-to-region-indirect-other-window)
           (progn (markdown-back-to-heading-over-code-block t) (point))
           (progn (markdown-end-of-subtree)
                  (if (and (markdown-heading-at-point) (not (eobp)))
                      (backward-char 1))
                  (point))
           (el-patch-add 0))))))


  (use-package edit-indirect-region-latex
    :after markdown-mode)
#+END_SRC

Now we set up pandoc-mode and add some utility functions

#+BEGIN_SRC emacs-lisp :noweb-ref pandoc
  (use-package pandoc-mode
    :bind
    ("C-c f" . pandoc--insert-feature)
    ("C-c C-s g" . markdown-insert-smallcaps)
    :init
    (defun pandoc--hline-for-new-slide (output-format)
      (if (member output-format '("revealjs" "beamer"))
          "---"
        ""))
    (defun pandoc--not-in-beamer (output-format text)
      (if (member output-format '("revealjs" "beamer"))
          ""
        text))
    (defun pandoc--pause (output-format)
      (if (member output-format '("revealjs" "beamer"))
          ". . ."
        ""))
    (defun pandoc--not-in-latex (output-format text)
      (if (string-equal output-format "latex")
          ""
        text))
    (defun pandoc--smallcaps (output-format txt)
      (format "[%s]{.smallcaps}" txt))

    (defun markdown-insert-smallcaps ()
      (interactive
       (if (markdown-use-region-p)
           ;; Active region
           (let ((bounds (markdown-unwrap-things-in-region
                          (region-beginning) (region-end)
                          markdown-regex-code 2 4)))
             (markdown-wrap-or-insert "[" "].{smallcaps}>" nil (car bounds) (cdr bounds)))
         ;; Code markup removal, code markup for word, or empty markup insertion
         (if (thing-at-point-looking-at markdown-regex-code)
             (markdown-unwrap-thing-at-point nil 0 1)
           (markdown-wrap-or-insert "[" "]{.smallcaps}" 'word nil nil)))))


    (setq my-pandoc-directives
          '(("slide" . pandoc--hline-for-new-slide)
            ("pause" . pandoc--pause)
            ("sc" . pandoc--smallcaps)
            ("notlatex" . pandoc--not-in-latex)
            ("notbeamer" . pandoc--not-in-beamer)))

    (defun pandoc--insert-feature (arg feature value)
      (interactive "P\nMFeature: \nMValue: ")
      (insert (format
               (if arg
                   "$%s$%s"
                 "[$%s$%s]")
               value feature)))
    :config
    (when (eq system-type 'darwin)
      (add-to-list 'pandoc-viewers '("docx" "open"))) 
    (add-hook 'pandoc-mode-hook
              (defun my-pandoc-mode-hook ()
                (setq pandoc-use-async t
                      pandoc-process-connection-type nil
                      pandoc-binary (if (eq system-type 'darwin)
                                        "/opt/homebrew/bin/pandoc"
                                      "/usr/bin/pandoc"))
                (local-set-key (kbd "C-c &") 'pandoc-jump-to-reference)
                (pandoc-load-default-settings)
                (dolist (x my-pandoc-directives)
                  (add-to-list 'pandoc-directives x))))

    (defun make-slides-handout-filename (filename)
      "For non-nil filenames, add an appropriate suffix to the
  filename depending on the output format."
      (when filename
        (format "%s%s.%s"
                (file-name-sans-extension filename)
                (pcase (pandoc--get 'write)
                  ("latex" "-handout")
                  ("beamer" "-slides")
                  (- ""))
                (file-name-extension filename))))

    (defun make-slides-or-handout (oldfun &rest args)
      "Hijack the output setting to wrangle the filenames if
  necessary, otherwise just pass through."
      (if (eq (pandoc--get 'output) 'slides-or-handout)
          (progn (pandoc--set 'output t)
                 (setq final-filename (make-slides-handout-filename (apply oldfun args)))
                 (pandoc--set 'output 'slides-or-handout)
                 final-filename)
        (apply oldfun args)))

    (advice-add 'pandoc--compose-output-file-name :around #'make-slides-or-handout))



#+END_SRC

** BibTeX

This defines a function (call it using =M-x get-bibtex-from-doi=)
that, given a DOI (or an http://dx.doi.org/ URL) gets a BibTeX entry
and inserts it at point.

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (defun bibtex->biblatex (entry)
    (replace-regexp-in-string "year[[:blank:]]*="
                              "date ="
                              (replace-regexp-in-string "journal[[:blank:]]*="
                                                        "journaltitle ="
                                                        entry)))


  (defun get-bibtex-from-doi (doi)
    "Get a BibTeX entry from the DOI"
    (interactive "MDOI: ")
    (let ((url-mime-accept-string "text/bibliography;style=bibtex")
          (clean-doi (replace-regexp-in-string "https?://.*doi.org/" "" doi)))
      (with-current-buffer (url-retrieve-synchronously (format "http://doi.org/%s" clean-doi))
        (switch-to-buffer (current-buffer))
        (setq bibtex-entry (buffer-substring (string-match "@" (buffer-string)) (point-max)))
        (kill-buffer (current-buffer))))
    (insert (bibtex->biblatex (decode-coding-string bibtex-entry 'utf-8)))
    (bibtex-fill-entry))
#+END_SRC

*** RefTex and bibtex-mode

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package reftex
    :commands turn-on-reftex
    :config
    (setq reftex-use-external-file-finders t
          reftex-plug-into-AUCTeX t
          reftex-default-bibliography `(,private/bibliography-file)
          reftex-cite-prompt-optional-args nil
          reftex-cite-cleanup-optional-args t)
    (global-unset-key "\C-c /")
    (add-to-list 'reftex-bibliography-commands "addbibresource")
  
    (let ((kpsewhich (string-trim-right (shell-command-to-string "which kpsewhich"))))
      (setq reftex-external-file-finders
            `(("tex" . ,(concat kpsewhich " -format=.tex %f"))
              ("bib" . ,(concat kpsewhich " -format=.bib %f")))))
  
    (defun my/buffer-file-name-for-reftex (old-fn &optional buffer)
      "Make RefTeX work in indirect buffers"
      (let ((bfn (funcall old-fn buffer)))
        (if reftex-mode
            (or bfn
                (let ((base (buffer-base-buffer buffer)))
                  (when base
                    (funcall old-fn base))))
          bfn)))
  
    (advice-add #'buffer-file-name :around #'my/buffer-file-name-for-reftex))
  
  
  (use-package bibtex
    :mode ("\\.bib" . bibtex-mode)
    :config
    (setq bibtex-align-at-equal-sign t
          bibtex-autokey-year-length 4
          bibtex-autokey-titleword-length nil
          bibtex-autokey-titlewords-stretch 0
          bibtex-autokey-titlewords 1
          bibtex-autokey-year-title-separator "")
  
    (add-hook 'bibtex-mode-hook
              (lambda ()
                (set-fill-column 120)))
  
    (defun bibtex-autokey-parse-date ()
      "Get the year from the `date' field in biblatex format, else the `year' field"
      (let ((date-string (car (split-string (bibtex-autokey-get-field "date") "-"))))
        (if (string-equal date-string "")
            (bibtex-autokey-get-field "year")
          date-string)))
    (defun bibtex-autokey-get-year ()
      "Use the custom date parse function, and return year field
  contents as a string obeying `bibtex-autokey-year-length'."
      (let ((yearfield (bibtex-autokey-parse-date)))
        (substring yearfield (max 0 (- (length yearfield)
                                       bibtex-autokey-year-length))))))
  
  
  (use-package bibtex-utils
    :config
    (setq bu-bibtex-fields-ignore-list '(url abstract)))
#+END_SRC

*** Referencing 

#+BEGIN_SRC emacs-lisp :noweb-ref org
  (use-package org-ref
    :after (org oc)
    :bind (:map org-mode-map
                (("C-c )" . org-ref-insert-link-hydra/body)))
    :config
    (require 'org-ref-helm))

  (use-package oc
    :straight nil
    :after org
    :config
    (setq org-cite-global-bibliography `(,private/bibliography-file ,private/russian-bibliography-file)))

  (use-package oc-csl
    :straight nil
    :after oc
    :init
    (setq org-cite-csl-locales-dir (expand-file-name "etc/csl/" user-emacs-directory)
          org-cite-csl-styles-dir (expand-file-name "etc/csl/" user-emacs-directory)))

  (use-package oc-csl-activate
    :straight (:host github :repo "andras-simonyi/org-cite-csl-activate")
    :config
    (add-hook 'org-mode-hook (lambda () (cursor-sensor-mode 1)))
    (setq org-cite-activate-processor 'csl-activate
          org-cite-csl-activate-use-document-style t))

#+END_SRC

** Helm-Bibtex

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package helm-bibtex
    :after oc-csl
    :bind
    ;; (:map LaTeX-mode-map (("C-c ]" . helm-bibtex)))
    ("C-c ]" . helm-bibtex)
    :config
    (setq bibtex-completion-bibliography `(,private/bibliography-file)
          bibtex-completion-library-path private/pdf-directory
          bibtex-completion-pdf-open-function 'find-file
          bibtex-completion-cite-prompt-for-optional-arguments nil
          bibtex-completion-additional-search-fields '(subtitle booktitle booksubtitle date maintitle mainsubtitle)
          bibtex-completion-cite-default-command "parencite"
          bibtex-completion-display-formats '((t . "${author:20} ${title:*} ${date:4} ${=has-pdf=:1} ${=type=:7}")))

    (advice-add 'bibtex-completion-candidates :filter-return 'reverse)

    (add-to-list 'bibtex-completion-format-citation-functions
                 '(org-mode . bibtex-completion-format-citation-org-cite))

    (defun helm-bibtex-insert-citeproc-reference (_candidate)
        (let* ((locale-getter (citeproc-locale-getter-from-dir helm-bibtex-csl-locale-dir))
               (item-getter (citeproc-itemgetter-from-bibtex helm-bibtex-bibliography))
               (proc (citeproc-create helm-bibtex-csl-style item-getter locale-getter))
               (cites (mapcar (lambda (x)
                                (citeproc-citation-create :cites `(((id . ,x)))))
                              (helm-marked-candidates))))
          (citeproc-append-citations cites proc)
          (insert (car (citeproc-render-bib proc 'plain)))))

    (progn (dolist (action '("Insert citation" "Insert formatted citation(s)" "Insert formatted reference" "Insert reference"))
             (helm-delete-action-from-source action helm-source-bibtex))
           (helm-add-action-to-source "Insert citation" 'helm-bibtex-insert-citation helm-source-bibtex 0)
           (helm-add-action-to-source "Insert formatted reference" 'helm-bibtex-insert-citeproc-reference helm-source-bibtex 3))

    (defvar helm-bibtex-csl-style (expand-file-name "etc/csl/unified-style-linguistics.csl" user-emacs-directory))
    (defvar helm-bibtex-csl-locale-dir (expand-file-name "etc/csl/" user-emacs-directory)))

#+END_SRC

** Word count goals

#+begin_src emacs-lisp :noweb-ref utils
  (use-package wc-goal-mode
    :config
    (setq wc-goal-modeline-format "WCΔ[%w/%gw]"))
#+end_src

** Evil

Evil is a mode that makes vi(m) like keybindings

#+BEGIN_SRC emacs-lisp :noweb-ref evil 
  (use-package evil
    :init
    (setq evil-want-C-i-jump nil
          evil-want-fine-undo t
          evil-search-module 'evil-search
          evil-undo-system 'undo-tree)
    :config
    (evil-mode 1)
    (define-key evil-normal-state-map (kbd "<remap> <evil-next-line>") 'evil-next-visual-line)
    (define-key evil-normal-state-map (kbd "<remap> <evil-previous-line>") 'evil-previous-visual-line)
    (define-key evil-motion-state-map (kbd "<remap> <evil-next-line>") 'evil-next-visual-line)
    (define-key evil-motion-state-map (kbd "<remap> <evil-previous-line>") 'evil-previous-visual-line)
    (define-key evil-insert-state-map (kbd "C-e") 'end-of-line)
    ;; (define-key evil-motion-state-map (kbd "<SPC>") 'evil-window-map)

    (setq-default evil-cross-lines t
                  sentence-end-double-space nil
                  evil-default-state 'normal)

    (cl-loop for (mode . state) in
             '((inferior-emacs-lisp-mode . emacs)
               (shell-mode . insert)
               (git-commit-mode . insert)
               (term-mode . emacs)
               (dired-mode . emacs)
               (wdired-mode . normal)
               (inferior-ess-mode . emacs)
               (help-mode . emacs)
               (comint-mode . emacs)
               (inferior-python-mode . emacs)
               (eww-mode . emacs)
               (undo-tree-visualizer . emacs)
               (mu4e-view-mode . emacs)
               (paradox-menu-mode . emacs)
               (vterm-mode . emacs)
               (flycheck-error-list-mode . emacs)
               (reaper-mode . emacs)
               (iESS-mode . emacs)
               (cfw:details-mode . emacs)
               (cfw:calendar-mode . emacs)
               (dashboard-mode . emacs)
               (helpful-mode . emacs)
               (deft-mode . emacs)
               (git-timemachine-mode . emacs)
               (lsp-ui-imenu-mode . emacs)
               (reftex-index-mode . emacs))
             do (evil-set-initial-state mode state)))

  (use-package evil-surround
    :config (global-evil-surround-mode 1))

  (use-package evil-exchange
    :config (evil-exchange-install))

  (use-package evil-goggles
    :diminish evil-goggles-mode
    :config (evil-goggles-mode))

  (use-package evil-snipe
    :config
    (evil-snipe-mode +1)
    (evil-snipe-override-mode +1)
    (add-hook 'magit-mode-hook 'turn-off-evil-snipe-override-mode)
    :diminish
    evil-snipe-local-mode
    evil-snipe-override-mode
    :custom
    (evil-snipe-scope 'whole-line)
    (evil-snipe-repeat-scope 'whole-visible))

  (when (eq system-type 'darwin)
    (use-package evil-escape
      :after evil
      :config
      (setq-default evil-escape-key-sequence "jk")
      (evil-escape-mode)))
#+END_SRC

** Avy

Search-based navigation

#+begin_src emacs-lisp :noweb-ref evil
  (use-package avy
    :bind
    ("C-c C-j" . avy-resume)
    ("M-g s" . avy-goto-char-timer)
    ("M-g w" . avy-goto-word-1)
    ("M-g :" . avy-goto-char-2))
#+end_src

** Easymotion

#+begin_src emacs-lisp :noweb-ref evil
  (use-package evil-easymotion
    :config
    (evilem-default-keybindings "SPC"))
#+end_src

** Lilypond

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package lilypond-mode
    :straight nil
    :mode ("\\.ly$" . LilyPond-mode))
#+END_SRC

** Typopunct-mode

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package typopunct
    :load-path "~/.emacs.d/lisp/"
    :config
    (setq-default typopunct-buffer-language 'english)
    (defconst typopunct-ellipsis (decode-char 'ucs #x2026))
    (defun typopunct-insert-ellipsis (arg)
      "Change three consecutive dots to an ellipsis mark"
      (interactive "p")
      (cond
       ((and (= 1 arg)
             (eq this-command last-command)
             (looking-back "\\.\\."))
        (replace-match "")
        (insert typopunct-ellipsis))
       (t
        (self-insert-command arg))))
    (define-key typopunct-map "." 'typopunct-insert-ellipsis)
    (add-to-list 'typopunct-language-alist '(norsk "«" "»" "‘" "’")))
#+END_SRC

** Org-marginalia

Use marginal annotations in org-mode with any file.

#+begin_src emacs-lisp :noweb-ref editing
  (use-package org-marginalia
    :straight (:host github :repo "nobiot/org-marginalia")
    :bind (:map org-marginalia-mode-map
                (("C-c n o" . org-marginalia-open)
                 ("C-c m" . org-marginalia-mark)
                 ("C-c n ]" . org-marginalia-next)
                 ("C-c n [" . org-marginalia-prev)))
    :config
    (setq org-marginalia-notes-file-path (expand-file-name "marginalia.org" private/org-roam-directory)))
#+end_src

** Undo-tree

Properly setup undo-tree

#+begin_src emacs-lisp :noweb-ref editing
  (use-package undo-tree
    :config
    (setq undo-tree-visualizer-timestamps t
          undo-tree-visualizer-diff t
          undo-tree-auto-save-history nil)
    (global-undo-tree-mode))
#+end_src

** Accent entry

Completion for accent entries

#+begin_src emacs-lisp :noweb-ref editing
  (use-package accent
    :bind
    ("C-x M-a" . accent-menu)
    :config
    (setq accent-custom '((a (ă))
                          (e (ĕ))
                          (i (ĭ))
                          (o (ŏ))
                          (u (ŭ))
                          (y (ȳ)))))
#+end_src

* Other useful utilities
** Session management

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package psession
    :disabled t
    :config
    (psession-mode 1)
    (add-to-list 'psession-object-to-save-alist '(helm-ucs--names . "helm-ucs--names.el")))
#+END_SRC

** Auto save

This is a lightweight auto-save mode

#+begin_src emacs-lisp :noweb utils
  (use-package salv
    :straight (:host github :repo "alphapapa/salv.el")
    :hook
    (LaTeX-mode . salv-mode)
    (org-mode . salv-mode)
    (markdown-mode . salv-mode)
    (ess-r-mode . salv-mode))
#+end_src

** Fussy completion

#+begin_src emacs-lisp :noweb-ref utils
  (use-package fussy
    :straight (:host github :repo "jojojames/fussy")
    :config
    (push 'fussy completion-styles)
    (setq
     ;; For example, project-find-file uses 'project-files which uses
     ;; substring completion by default. Set to nil to make sure it's using
     ;; flx.
     completion-category-defaults nil
     completion-category-overrides nil))

  (use-package fzf-native
    :disabled (eq system-type 'darwin)
    :straight
    (fzf-native
     :repo "dangduc/fzf-native"
     :host github
     :files (:defaults "bin"))
    :config
    (setq fussy-score-fn 'fussy-fzf-native-score)
    (fzf-native-load-dyn))
#+end_src

** COMMENT New completion systems

Vertico is the UI

#+begin_src emacs-lisp :noweb-ref utils
  (use-package vertico
    :init
    (vertico-mode)
    (setq vertico-scroll-margin 0
          vertico-count 20
          vertico-resize t
          vertico-cycle t))

  ;; Persist history over Emacs restarts. Vertico sorts by history position.
  (use-package savehist
    :init
    (savehist-mode))

  ;; A few more useful configurations...
  (use-package emacs
    :straight nil
    :init
    ;; Add prompt indicator to `completing-read-multiple'.
    ;; We display [CRM<separator>], e.g., [CRM,] if the separator is a comma.
    (defun crm-indicator (args)
      (cons (format "[CRM%s] %s"
                    (replace-regexp-in-string
                     "\\`\\[.*?]\\*\\|\\[.*?]\\*\\'" ""
                     crm-separator)
                    (car args))
            (cdr args)))
    (advice-add #'completing-read-multiple :filter-args #'crm-indicator)

    ;; Do not allow the cursor in the minibuffer prompt
    (setq minibuffer-prompt-properties
          '(read-only t cursor-intangible t face minibuffer-prompt))
    (add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)

    ;; Emacs 28: Hide commands in M-x which do not work in the current mode.
    ;; Vertico commands are hidden in normal buffers.
    (setq read-extended-command-predicate
          #'command-completion-default-include-p)

    ;; Enable recursive minibuffers
    (setq enable-recursive-minibuffers t))
#+end_src

Orderless completion to enable splitting on spaces

#+begin_src emacs-lisp :noweb-ref utils
  ;; Optionally use the `orderless' completion style.
  (use-package orderless
    :init
    (setq completion-styles '(orderless basic)
          completion-category-defaults nil
          completion-category-overrides '((file (styles partial-completion)))))
#+end_src

Marginalia allows annotation in the completion minibuffer

#+begin_src emacs-lisp :noweb-ref utils
  (use-package marginalia
    :bind (("M-A" . marginalia-cycle)
           :map minibuffer-local-map
           ("M-A" . marginalia-cycle))
    :init
    (marginalia-mode))
#+end_src

Embark provides actions on completion candidates

#+begin_src emacs-lisp :noweb-ref utils
  (use-package embark
    :bind
    (("C-." . embark-act)
     ("C-;" . embark-dwim)
     ("C-h B" . embark-bindings))

    :init
    ;; Optionally replace the key help with a completing-read interface
    (setq prefix-help-command #'embark-prefix-help-command)
    :config
    ;; Hide the mode line of the Embark live/completions buffers
    (add-to-list 'display-buffer-alist
                 '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                   nil
                   (window-parameters (mode-line-format . none)))))

  (use-package embark-consult
    :hook
    (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

Consult is a collection of useful actions in completion buffers

#+begin_src emacs-lisp :noweb-ref utils
  ;; Example configuration for Consult
  (use-package consult
    :bind (;; C-c bindings (mode-specific-map)
           ("C-c h" . consult-history)
           ("C-c m" . consult-mode-command)
           ("C-c k" . consult-kmacro)
           ;; C-x bindings (ctl-x-map)
           ("C-x M-:" . consult-complex-command)     ;; orig. repeat-complex-command
           ("C-x b" . consult-buffer)                ;; orig. switch-to-buffer
           ("C-x 4 b" . consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
           ("C-x 5 b" . consult-buffer-other-frame)  ;; orig. switch-to-buffer-other-frame
           ("C-x r b" . consult-bookmark)            ;; orig. bookmark-jump
           ("C-x p b" . consult-project-buffer)      ;; orig. project-switch-to-buffer
           ;; Custom M-# bindings for fast register access
           ("M-#" . consult-register-load)
           ("M-'" . consult-register-store)          ;; orig. abbrev-prefix-mark (unrelated)
           ("C-M-#" . consult-register)
           ;; Other custom bindings
           ("M-y" . consult-yank-pop)                ;; orig. yank-pop
           ;; M-g bindings (goto-map)
           ("M-g e" . consult-compile-error)
           ("M-g f" . consult-flymake)               ;; Alternative: consult-flycheck
           ("M-g g" . consult-goto-line)             ;; orig. goto-line
           ("M-g M-g" . consult-goto-line)           ;; orig. goto-line
           ("M-g o" . consult-outline)               ;; Alternative: consult-org-heading
           ("M-g m" . consult-mark)
           ("M-g k" . consult-global-mark)
           ("M-g i" . consult-imenu)
           ("M-g I" . consult-imenu-multi)
           ;; M-s bindings (search-map)
           ("M-s d" . consult-find)
           ("M-s D" . consult-locate)
           ("M-s g" . consult-grep)
           ("M-s G" . consult-git-grep)
           ("M-s r" . consult-ripgrep)
           ("M-s l" . consult-line)
           ("M-s L" . consult-line-multi)
           ("M-s k" . consult-keep-lines)
           ("M-s u" . consult-focus-lines)
           ;; Isearch integration
           ("M-s e" . consult-isearch-history)
           :map isearch-mode-map
           ("M-e" . consult-isearch-history)         ;; orig. isearch-edit-string
           ("M-s e" . consult-isearch-history)       ;; orig. isearch-edit-string
           ("M-s l" . consult-line)                  ;; needed by consult-line to detect isearch
           ("M-s L" . consult-line-multi)            ;; needed by consult-line to detect isearch
           ;; Minibuffer history
           :map minibuffer-local-map
           ("M-s" . consult-history)                 ;; orig. next-matching-history-element
           ("M-r" . consult-history)                ;; orig. previous-matching-history-element
           :map org-mode-map
           ("C-c u" . consult-org-heading))

    ;; Enable automatic preview at point in the *Completions* buffer. This is
    ;; relevant when you use the default completion UI.
    :hook (completion-list-mode . consult-preview-at-point-mode)

    ;; The :init configuration is always executed (Not lazy)
    :init

    ;; Optionally configure the register formatting. This improves the register
    ;; preview for `consult-register', `consult-register-load',
    ;; `consult-register-store' and the Emacs built-ins.
    (setq register-preview-delay 0.5
          register-preview-function #'consult-register-format)

    ;; Optionally tweak the register preview window.
    ;; This adds thin lines, sorting and hides the mode line of the window.
    (advice-add #'register-preview :override #'consult-register-window)

    ;; Use Consult to select xref locations with preview
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref)

    ;; Configure other variables and modes in the :config section,
    ;; after lazily loading the package.
    :config

    ;; Optionally configure preview. The default value
    ;; is 'any, such that any key triggers the preview.
    ;; (setq consult-preview-key 'any)
    ;; (setq consult-preview-key (kbd "M-."))
    ;; (setq consult-preview-key (list (kbd "<S-down>") (kbd "<S-up>")))
    ;; For some commands and buffer sources it is useful to configure the
    ;; :preview-key on a per-command basis using the `consult-customize' macro.
    (consult-customize
     consult-theme :preview-key '(:debounce 0.2 any)
     consult-ripgrep consult-git-grep consult-grep
     consult-bookmark consult-recent-file consult-xref
     consult--source-bookmark consult--source-file-register
     consult--source-recent-file consult--source-project-recent-file
     ;; :preview-key (kbd "M-.")
     :preview-key '(:debounce 0.4 any))

    ;; Optionally configure the narrowing key.
    ;; Both < and C-+ work reasonably well.
    (setq consult-narrow-key "<") ;; (kbd "C-+")

    ;; Optionally make narrowing help available in the minibuffer.
    ;; You may want to use `embark-prefix-help-command' or which-key instead.
    ;; (define-key consult-narrow-map (vconcat consult-narrow-key "?") #'consult-narrow-help)

    ;; By default `consult-project-function' uses `project-root' from project.el.
    ;; Optionally configure a different project root function.
    ;; There are multiple reasonable alternatives to chose from.
    ;;;; 1. project.el (the default)
    ;; (setq consult-project-function #'consult--default-project--function)
    ;;;; 2. projectile.el (projectile-project-root)
    (autoload 'projectile-project-root "projectile")
    (setq consult-project-function (lambda (_) (projectile-project-root)))
    ;;;; 3. vc.el (vc-root-dir)
    ;; (setq consult-project-function (lambda (_) (vc-root-dir)))
    ;;;; 4. locate-dominating-file
    ;; (setq consult-project-function (lambda (_) (locate-dominating-file "." ".git")))
  )
#+end_src

Citar provides bibliography support

#+begin_src emacs-lisp :noweb-ref utils
  (use-package citar
    :bind (("C-c b" . citar-insert-citation)
           :map minibuffer-local-map
           ("M-b" . citar-insert-preset))
    :config
    (setq citar-bibliography `(,private/bibliography-file)
          citar-symbols `((file ,(all-the-icons-faicon "file-o" :face 'all-the-icons-green :v-adjust -0.1) . " ")
                          (note ,(all-the-icons-material "speaker_notes" :face 'all-the-icons-blue :v-adjust -0.3) . " ")
                          (link ,(all-the-icons-octicon "link" :face 'all-the-icons-orange :v-adjust 0.01) . " "))
          citar-symbol-separator "  "
          citar-library-paths private/pdf-directory
          org-cite-insert-processor 'citar
          org-cite-follow-processor 'citar
          org-cite-activate-processor 'citar))

  (use-package citar-embark
    :after citar embark
    :no-require
    :config (citar-embark-mode))

  (use-package citar-org-roam
    :after citar org-roam
    :no-require
    :config (citar-org-roam-mode))
#+end_src
** Helm

Helm is a powerful engine for completion and narrowing down
alternatives. No more blind tabbing! This setup follows the
introduction [[http://tuhdo.github.io/helm-intro.html][here]]. 

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package helm
    :bind
    (("M-x" . helm-M-x)
     ("M-y" . helm-show-kill-ring)
     ("C-x b" . helm-mini)
     ("C-x C-f" . helm-find-files)
     ("C-x C-h" . helm-for-files)
     ("C-s" . helm-occur)
     ("C-x C-d" . helm-browse-project))
    :commands (helm-buffers-list
	       helm-colors
	       helm-find-files
	       helm-for-files
	       helm-google-suggest
	       helm-mini
	       helm-help
	       helm-show-kill-ring
	       helm-org-keywords
	       helm-M-x
	       helm-occur)
    :diminish
    helm-mode
    :config
    (helm-mode)
    (require 'helm-config)
    (define-key helm-map (kbd "<tab>") 'helm-execute-persistent-action)
    (define-key helm-map (kbd "C-i") 'helm-execute-persistent-action)
    (define-key helm-map (kbd "C-z") 'helm-select-action)

    (when (executable-find "curl")
      (setq helm-google-suggest-use-curl-p t))

    (setq helm-split-window-in-side-p           t ; open helm buffer inside current window, not occupy whole other window
          helm-move-to-line-cycle-in-source     t ; move to end or beginning of source when reaching top or bottom of source.
          helm-scroll-amount                    8 ; scroll 8 lines other window using M-<next>/M-<prior>
          helm-use-frame-when-more-than-two-windows nil
          helm-ff-file-name-history-use-recentf t
          helm-buffers-fuzzy-matching t
          helm-recentf-fuzzy-match t
          helm-inherit-input-method nil
          helm-completion-style 'emacs)

    (helm-add-action-to-source "Attach to Email" #'mml-attach-file 
                               helm-source-locate))

  (use-package helm-dictionary
    :after helm)

  (use-package helm-org
    :bind ("C-c u" . helm-org-in-buffer-headings))

  (use-package helm-themes
    :after helm)

  (use-package helm-ag
    :after helm)
#+END_SRC

Helm-backup is a handy tool which puts all your saed files under Git
source control, by default under =~/.helm-backup=. Disable it if you
don't want or don't have that much space.

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package helm-backup
    :disabled t
    :config
    (global-set-key (kbd "C-c b") 'helm-backup)
    (add-hook 'after-save-hook 'helm-backup-versioning))
#+END_SRC

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package helm-descbinds
    :config
    (helm-descbinds-mode))
#+END_SRC

** Autocompletion

Set up =company-mode= for autocompletion.

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package company
    :config
    (global-company-mode)
    (setq company-global-modes '(not message-mode latex-mode markdown-mode)
          company-backends (remove 'company-dabbrev company-backends)))
  
  (use-package company-box
    :hook
    (company-mode . company-box-mode))
#+END_SRC

** Yasnippet

Yasnippet is a handy framework for storing little bits of code/text that you reuse a lot

#+BEGIN_SRC emacs-lisp :noweb-ref editing
  (use-package yasnippet
    :diminish
    yas-global-mode
    yas-minor-mode
    :config
    (yas-global-mode 1)
    (setq yas-wrap-around-region t))
#+END_SRC

** Various niceties

#+BEGIN_SRC emacs-lisp :noweb-ref init-after
  (setq display-time-day-and-date t)
  (setq display-time-string-forms
        '((format "%s:%s  "
                  24-hours minutes)
          (if display-time-day-and-date
              (format "%s %s %s" dayname monthname day) "")))
  (setq display-time-interval 30)
  (display-time-mode -1)

  (setq enable-recursive-minibuffers t)

  (use-package all-the-icons)

  (use-package vterm)

  (use-package vterm-toggle
    :after vterm
    :bind
    ("s-<return>" . vterm-toggle)
    ("M-s-<return>" . vterm-toggle-cd)
    (:map vterm-mode-map
          (([(control return)] . vterm-toggle-insert-cd))))
#+END_SRC

These are some convenience functions for my own use

#+BEGIN_SRC emacs-lisp :noweb-ref pandoc

  (defmacro clean-buffer (form)
    `(save-excursion
       (goto-char (point-min))
       ,form))

  (defun unsmart-quotes ()
    (interactive)
    (clean-buffer (replace-regexp "[‘’“”]" "'")))

  (defun clean-pandoc-output ()
    (interactive)
    (unsmart-quotes)
    (clean-buffer (replace-string "\\\\fshyp" "/"))
    (clean-buffer (replace-string "\\\\dash" " -- "))
    (clean-buffer (replace-regexp "\\\\hyp" "-"))
    (clean-buffer (replace-string "…" "..."))
    (clean-buffer (replace-regexp "\\\\iem?" "i.e."))
    (clean-buffer (replace-regexp "\\\\egm?" "e.g."))
    (clean-buffer (replace-regexp "\\\\cfm?" "cf."))
    (clean-buffer (replace-regexp "\\\\ipa{\\([^\}]+\\)}" "\\1"))
    (clean-buffer (replace-regexp "\\\\phonint{\\(.+\\)}" "⟦\\1⟧"))
    (clean-buffer (replace-regexp "\\\\featurestring{\\([^\}]+\\)}" "〈\\1〉"))
    (clean-buffer (replace-regexp "\\\\fea{\\([^\}]+\\)}{\\([^\}]+\\)}" "\\1[\\2]"))
    (clean-buffer (replace-regexp "\\\\mbox{\\([^\}]+\\)}" "\\1"))
    (clean-buffer (replace-regexp "\$?\\\\pm\$?" "±"))
    (clean-buffer (replace-regexp "\\\\[zba]\\." ""))
    (clean-buffer (replace-regexp "\\\\tw[pe]{\\([^\}]+\\)}{\\([^\}]+\\)}{\\([^\}]+\\)}" "\\1  \*\\2\*  '\\3'\n"))
    (clean-buffer (replace-regexp "\\\\mb[ip]\{\\([^\}]+\\)}" "\\1\n"))
    (clean-buffer (replace-regexp "\\\\rt" "×")))
#+END_SRC

** Calendar integration

This bit exports the agenda from my org-mode calendar to an iCalendar
and copies it to a remote server, where it gets picked up by the phone
calendar app.

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package org-caldav
    :config
    (setq org-caldav-url private/org-caldav-private-url
          org-caldav-calendar-id private/org-caldav-private-id
          org-caldav-inbox private/org-caldav-inbox
          org-caldav-files private/org-caldav-files
          org-icalendar-timezone "Europe/London"
          org-caldav-uuid-extension ".EML"
          org-caldav-calendars  `((:calendar-id ,private/org-caldav-private-id
                                                :url ,private/org-caldav-private-url))))



  (defun sync-calendar ()
    (interactive)
    (let ((org-icalendar-combined-agenda-file private/combined-agenda-file))
      (org-icalendar-combine-agenda-files)
      (shell-command (format "rsync -avzz %s %s" 
                             org-icalendar-combined-agenda-file private/calendar-destination)))
    (org-caldav-sync)
    (with-current-buffer (get-file-buffer org-caldav-inbox)
      (save-buffer))
    (with-current-buffer (get-file-buffer main-agenda-file)
      (save-buffer)))

  (use-package calfw
    :config (use-package calfw-org))

#+END_SRC

** Email
*** Signatures

This is just a convenience function to choose a signature at random from four versions

#+BEGIN_SRC emacs-lisp :noweb-ref mail

  (defun make-random-signature ()
  (interactive)
  (let ((sigs (list
  "Pavel Iosad\nLinguistics and English Language\nThe University of Edinburgh\nDugald Stewart Building\n3 Charles Street\nEdinburgh EH8 9AD\nScotland\n\nhttp://www.ed.ac.uk/profile/pavel-iosad"

  "Pavel Iosad\nRoinn a' Chànanachais agus na Beurla\nOilthigh Dhùn Èideann\nTogalach Dhùghaill Stiùbhairt\n3 Sràid Theàrlaich\nDùn Èideann EH8 9AD\nAlba\n\nhttp://www.ed.ac.uk/profile/pavel-iosad\n\nIs e buidheann carthannais a tha ann an Oilthigh Dhùn Èideann,\nclàraichte ann an Albainn, le àireamh clàraidh SC005336.\n"

  "Pavel Iosad\nAdran Ieithyddiaeth ac Iaith Saesneg\nPrifysgol Caeredin\nAdeilad Dugald Stewart\n3 Stryd Siarl\nCaeredin EH8 9AD\nYr Alban\n\nhttp://www.ed.ac.uk/profile/pavel-iosad\n\nMae Prifysgol Caeredin yn elusen gofrestredig yn yr Alban,\ngyda rhif cofrestru SC005336.\n"

  "Pavel Iosad\nRoinn na Teangeolaíochta agus na Béarla\nOllscoil Dhún Éideann\nÁras Dhúghaill Stíobhaird\n3 Sráid Shéarlais\nDún Éideann EH8 9AD\nAlbain\n\nhttp://www.ed.ac.uk/profile/pavel-iosad\n\nIs carthanas í Ollscoil Dhún Éideann, cláraithe in Albain,\nle cláruimhir SC005336.\n"

  "Pavel Iosad\nInstitutt for språkvitskap og engelsk språk\nUniversitetet i Edinburgh\nDugald Stewarts hus\n3 Charles Street\nEdinburgh EH8 9AD\nSkottland\n\nhttp://www.ed.ac.uk/profile/pavel-iosad\n\nUniversitetet i Edinburgh er ein ideell organisasjon registrert i\nSkottland, med registrasjonsnr SC005336.\n")))
  (nth (random (length sigs)) sigs)))
#+END_SRC

*** Drafts folder

Keep the Drafts folder clean

#+BEGIN_SRC emacs-lisp :noweb-ref mail
  (defun draft-auto-save-buffer-name-handler (operation &rest args)
    "for `make-auto-save-file-name' set '.' in front of the file name; do nothing for other operations"  
    (if
        (and buffer-file-name (eq operation 'make-auto-save-file-name))
        (concat (file-name-directory buffer-file-name)
                "."
                (file-name-nondirectory buffer-file-name))
      (let ((inhibit-file-name-handlers
             (cons 'draft-auto-save-buffer-name-handler
                   (and (eq inhibit-file-name-operation operation)
                        inhibit-file-name-handlers)))
            (inhibit-file-name-operation operation))
        (apply operation args))))

  (add-to-list 'file-name-handler-alist '("Drafts/cur/" . draft-auto-save-buffer-name-handler))
#+END_SRC

*** Main mu4e configuration

I use [[http://www.djcb.org/mu4e][mu4e]] to read my email

#+BEGIN_SRC emacs-lisp :noweb-ref mail
  (unless (eq system-type 'darwin)
    (use-package mu4e
      :commands (mu4e compose-mail)
      :load-path  "/usr/share/emacs/site-lisp/mu4e/"
      :bind ("<f5>" . mu4e)
      :hook
      (mu4e-headers-mode . buffer-face-mode)
      :config
      (setq mu4e-update-interval 300
            mu4e-change-filenames-when-moving t
            mu4e-attachment-dir  "~/Downloads"
            mu4e-view-show-images t
            mu4e-get-mail-command "mbsync -a"
            mail-user-agent 'mu4e-user-agent
            mu4e-compose-complete-addresses t
            mu4e-compose-complete-only-after "2012-09-15"
            mu4e-headers-include-related nil
            mu4e-hide-index-messages t
            message-send-mail-function 'message-send-mail-with-sendmail
            sendmail-program "/usr/bin/msmtp"
            mu4e-use-fancy-chars t
            mu4e-headers-seen-mark      '("S" . "✔")
            mu4e-headers-unread-mark    '("u" . "●")
            mu4e-headers-new-mark       '("N" . "○")
            mu4e-headers-replied-mark   '("R" . "←")
            mu4e-headers-passed-mark    '("P" . "→")
            mu4e-headers-flagged-mark   '("F" . "⚑")
            mu4e-headers-draft-mark     '("D" . "⚒")
            mu4e-headers-encrypted-mark '("x" . "e")
            mu4e-headers-signed-mark    '("s" . "s")
            mu4e-headers-trashed-mark   '("T" . "×")
            mu4e-headers-attach-mark    '("a" . "A")
            mu4e-headers-visible-flags  '(draft flagged passed replied unread attach)
            mu4e-headers-default-prefix     '("|" . "│")
            mu4e-headers-has-child-prefix   '("+" . "└")
            mu4e-headers-first-child-prefix '("\\" . "└")
            mu4e-index-cleanup t
            mu4e-index-lazy-check nil
            mu4e-headers-date-format "%d-%m-%Y"
            message-kill-buffer-on-exit t
            mu4e-compose-dont-reply-to-self t
            mu4e-compose-keep-self-cc nil
            smtpmail-queue-dir "~/mail/queue/cur")

      (define-key mu4e-headers-mode-map (kbd "i") 'mu4e-update-index)

      (defvar ignore-email nil)
      (defun ignore-email-toggle ()
        (interactive)
        (setq ignore-email (not ignore-email)))

      (defun my-mu4e-update-hook ()
        "Only check email automatically on weekdays"
        (setq mu4e-get-mail-command
              (if (or ignore-email (member (nth 6 (decode-time)) '(6 0)))
                  "true"
                "mbsync -a")))
      (add-hook 'mu4e-update-pre-hook #'my-mu4e-update-hook)


      (setq unread-query "flag:unread maildir:/work/Inbox or flag:unread maildir:/outlook/INBOX")

      (add-to-list 'mu4e-bookmarks
                   '("date:today..now AND NOT flag:trashed AND NOT from:iosad" "Today's messages" ?t))

      (add-to-list 'mu4e-bookmarks
                   '("flag:flagged" "Flagged messages" ?f))

      (add-to-list 'mu4e-bookmarks `(,unread-query "Unread messages" ?u))

      (setq user-full-name "Pavel Iosad"
            user-mail-address "pavel.iosad@ed.ac.uk"
            mu4e-compose-reply-to-address nil
            mu4e-compose-signature (make-random-signature)
            mu4e-drafts-folder "/outlook/Drafts"
            mu4e-sent-folder "/outlook/Sent Items"
            mu4e-trash-folder "/outlook/Deleted Items"
            mu4e-refile-folder "/outlook/Archive"
            mu4e-maildir-shortcuts '((:maildir "/outlook/INBOX" :key ?i)
                                     (:maildir "/outlook/Archive" :key ?a)
                                     (:maildir "/outlook/Sent Items" :key ?s :hide-unread t)
                                     (:maildir "/outlook/Deleted Items" :key ?t :hide t))
            message-sendmail-extra-arguments nil)

      ;; (setq mu4e-contexts
      ;;       `(,(make-mu4e-context
      ;;           :name "Work"
      ;;           :enter-func (lambda () (mu4e-message "Entering main work context"))
      ;;           :leave-func (lambda () (mu4e-message "Leaving main work context"))
      ;;           :match-func (lambda (msg)
      ;;                         (when msg
      ;;                           (mu4e-message-contact-field-matches msg :to "iosad")))
      ;;           :vars '((user-full-name . "Pavel Iosad")
      ;;                   (user-mail-address . "pavel.iosad@ed.ac.uk")
      ;;                   (mu4e-compose-reply-to-address . nil)
      ;;                   (mu4e-compose-signature . (make-random-signature))
      ;;                   (mu4e-drafts-folder . "/outlook/Drafts")
      ;;                   (mu4e-sent-folder . "/outlook/Sent Items")
      ;;                   (mu4e-trash-folder . "/outlook/Deleted Items")
      ;;                   (mu4e-refile-folder . "/outlook/Archive")
      ;;                   (mu4e-maildir-shortcuts . ((:maildir "/outlook/INBOX" :key ?i)
      ;;                                              (:maildir "/outlook/Archive" :key ?a)
      ;;                                              (:maildir "/outlook/Sent Items" :key ?s :hide-unread t)
      ;;                                              (:maildir "/outlook/Deleted Items" :key ?t :hide t)))
      ;;                   (message-sendmail-extra-arguments . nil)))
      ;;         ,(make-mu4e-context
      ;;           :name "Personal"
      ;;           :enter-func (lambda () (mu4e-message "Entering personal context"))
      ;;           :leave-func (lambda () (mu4e-message "Leaving personal context"))
      ;;           :match-func (lambda (msg)
      ;;                         (when msg
      ;;                           (mu4e-message-contact-field-matches msg :to "anghyflawn")))
      ;;           :vars '((user-full-name . "Pavel Iosad")
      ;;                   (user-mail-address . "pavel@anghyflawn.net")
      ;;                   (mu4e-compose-reply-to-address . nil)
      ;;                   (mu4e-compose-signature . "Pavel Iosad")
      ;;                   (mu4e-drafts-folder . "/work/Drafts")
      ;;                   (mu4e-sent-folder . "/work/Sent")
      ;;                   (mu4e-trash-folder . "/work/Trash")
      ;;                   (mu4e-refile-folder . "/work/Archive")
      ;;                   (mu4e-maildir-shortcuts . ((:maildir "/work/Inbox" :key ?i)
      ;;                                              (:maildir "/work/Archive" :key ?a)
      ;;                                              (:maildir "/work/Sent" :key ?s :hide-unread t)
      ;;                                              (:maildir "/work/Trash" :key ?t :hide t)))
      ;;                   (message-sendmail-extra-arguments . ("-a" "personal")))))
      ;;       mu4e-context-policy 'pick-first
      ;;       mu4e-compose-context-policy 'ask)


      (add-hook 'mu4e-compose-mode-hook
                (defun my-compose-mode-hook ()
                  (setq mu4e-compose-signature (make-random-signature))
                  (auto-fill-mode)
                  (set-fill-column 72)
                  (typopunct-mode)
                  (flyspell-mode)))))

  (use-package mu4e-alert
    :bind (("<f7>" . mu4e-alert-view-unread-mails))
    :commands (mu4e)
    :config
    (mu4e-alert-enable-mode-line-display)
    (mu4e-alert-set-default-style 'notifications)
    (setq mu4e-alert-interesting-mail-query unread-query)
    (add-hook 'after-init-hook #'mu4e-alert-enable-notifications))

  (use-package org-mu4e
    :straight nil
    :config
    (setq org-mu4e-link-query-in-headers-mode nil
          org-capture-templates '(("t" "todo" entry (file+headline main-agenda-file "Tasks") "* TODO %?\n%a")
                                  ("e" "event" entry (file+headline main-agenda-file "Events from email") "* %?\n%^{Date + time}T\n%a")))) 


#+END_SRC

*** COMMENT Additional mu4e modules

#+begin_src emacs-lisp :noweb-ref mail
    (use-package helm-mu
      :bind ("C-c C-x m" . helm-mu-contacts)
      ("<f6>" . helm-mu)
      :config
      (setq helm-mu-contacts-after "15-Sep-2012 00:00:00")
      :bind
      (:map mu4e-main-mode-map
            ("s" . helm-mu))
      (:map mu4e-headers-mode-map
            ("s" . helm-mu))
      (:map mu4e-view-mode-map
            ("s" . helm-mu)))

  (use-package mu4e-icalendar
    :straight nil
    (mu4e-icalendar-setup))
          #+end_src

** Browser

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package osx-browse
    :commands osx-browse-mode)
  (pcase system-type
          ('gnu-linux (setq browse-url-browser-function 'helm-browse-url-firefox))
          ('darwin (progn (osx-browse-mode 1)
                          (setq browse-url-browser-function 'osx-browse-url-firefox))))
#+END_SRC

** Search

=Swiper= is nice for searching longer files

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package swiper-helm
    :bind
    ("C-s" . swiper-helm)
    ("C-%" . swiper-query-replace))
#+END_SRC

** PDF tools

Much better than DocView

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package pdf-tools
    :magic ("%PDF" . pdf-view-mode)
    :config
    (pdf-tools-install :no-query)
    (setq pdf-view-resize-factor 1.1
          pdf-view-use-scaling t)
    (define-key pdf-view-mode-map (kbd "C-s") 'isearch-forward))
#+END_SRC

** COMMENT Dired

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package dired-narrow
    :bind (:map dired-mode-map
                ("/" . dired-narrow)))

  (use-package dired-open
    :bind (:map dired-mode-map
                ("K" . dired-open-xdg)))
#+END_SRC

** Dirvish

Updated dired

#+begin_src emacs-lisp :noweb-ref utils
  (use-package dirvish
    :init
    (dirvish-override-dired-mode)
    :custom
    (dirvish-mode-line-format '(:left (sort file-time " " file-size symlink) :right (omit yank index)))
    (dirvish-attributes '(all-the-icons file-size collapse subtree-state vc-state))
    :config
    (dirvish-peek-mode)
    :bind
    (("C-c f" . dirvish-fd)))
#+end_src
** Helpful

A drop-in replacement for Emacs' help buffers

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package helpful
    :bind
    (("C-h f" . helpful-callable)
     ("C-h v" . helpful-variable)
     ("C-h k" . helpful-key)
     ("C-c F" . helpful-function)
     ("C-c C" . helpful-command)))
#+END_SRC

** COMMENT Anki-editor

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package anki-editor
    :config
    (add-hook 'anki-editor-mode-hook
              '(lambda ()
                 (use-local-map (copy-key-map org-mode-map))
                 (local-set-key (kbd "M-RET") 'anki-editor-insert-note))))
#+END_SRC

** COMMENT Tabs

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package centaur-tabs
    :config
    (centaur-tabs-mode t)
    (centaur-tabs-headline-match)
    (setq centaur-tabs-style "chamfer"
          centaur-tabs-set-icons t
          centaur-tabs-set-bar 'over
          centaur-tabs-set-modified-marker t
          centaur-tabs-gray-out-icons 'buffer)
    (defun centaur-tabs-buffer-groups ()
      "`centaur-tabs-buffer-groups' control buffers' group rules.

  Group centaur-tabs with mode if buffer is derived from `eshell-mode' `emacs-lisp-mode' `dired-mode' `org-mode' `magit-mode'.
  All buffer name start with * will group to \"Emacs\".
  Other buffer group by `centaur-tabs-get-group-name' with project name."
      (list
       (cond
        ((or (string-match-p "mu4e" (buffer-name))
             (derived-mode-p 'message-mode))
         "Email")
        ((or (string-equal "*" (substring (buffer-name) 0 1))
             (string-match-p "synctex" (buffer-name))
             (memq major-mode '(magit-process-mode
                                magit-status-mode
                                magit-diff-mode
                                magit-log-mode
                                magit-file-mode
                                magit-blob-mode
                                magit-blame-mode)))
         "Emacs")
        ((derived-mode-p 'prog-mode)
         "Editing")
        ((derived-mode-p 'dired-mode)
         "Dired")
        ((memq major-mode '(helpful-mode
                            help-mode))
         "Help")
        ((memq major-mode '(org-mode
                            org-agenda-clockreport-mode
                            org-src-mode
                            org-agenda-mode
                            org-beamer-mode
                            org-indent-mode
                            org-bullets-mode
                            org-cdlatex-mode
                            org-agenda-log-mode
                            diary-mode))
         "OrgMode")
        ((memq major-mode '(pdf-view-mode))
         "PDF")
        (t
         (centaur-tabs-get-group-name (current-buffer))))))

    (defun centaur-tabs-hide-tab (x)
      (let ((name (format "%s" x)))
        (or
         (string-prefix-p "*epc" name)
         (string-prefix-p "*helm" name)
         (string-prefix-p "*Helm" name)
         (string-prefix-p "*Compile-Log*" name)
         (string-match-p "synctex" name)
         (string-suffix-p "output*" name)
         (string-suffix-p ".log" name)
         (and (string-prefix-p "magit" name)
              (not (file-name-extension name))))))

    :hook
    (dashboard-mode . centaur-tabs-local-mode)
    (org-agenda-mode . centaur-tabs-local-mode)
    (helpful-mode . centaur-tabs-local-mode)
    (lsp-ui-doc-mode . centaur-tabs-local-mode)
    :bind
    ("C-<prior>" . centaur-tabs-backward)
    ("C-<next>" . centaur-tabs-forward)
    ("C-c T p" . centaur-tabs-group-by-projectile-project)
    ("C-c T g" . centaur-tabs-group-buffer-groups)
    (:map evil-normal-state-map
          ("g t" . centaur-tabs-forward)
          ("g T" . centaur-tabs-backward)))
#+END_SRC

** Buffer grouping

Trying to use this

#+begin_src emacs-lisp :noweb-ref utils
  (use-package bufler
    :after evil
    :config
    (evil-set-initial-state 'bufler-list-mode 'emacs))

  (use-package helm-bufler
    :after (helm bufler)
    :init
    (defun helm-bufler-call ()
      (interactive)
      (helm :sources '(helm-bufler-source)))
    :bind
    ("C-x c C-b" . helm-bufler-call))

#+end_src

** COMMENT Treemacs

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package treemacs
    :defer t
    :config
    (progn
      (setq treemacs-collapse-dirs                 (if treemacs-python-executable 3 0)
            treemacs-deferred-git-apply-delay      0.5
            treemacs-directory-name-transformer    #'identity
            treemacs-display-in-side-window        t
            treemacs-eldoc-display                 t
            treemacs-file-event-delay              5000
            treemacs-file-follow-delay             0.2
            treemacs-file-name-transformer         #'identity
            treemacs-follow-after-init             t
            treemacs-git-command-pipe              ""
            treemacs-goto-tag-strategy             'refetch-index
            treemacs-indentation                   2
            treemacs-indentation-string            " "
            treemacs-is-never-other-window         nil
            treemacs-max-git-entries               5000
            treemacs-missing-project-action        'ask
            treemacs-no-png-images                 nil
            treemacs-no-delete-other-windows       t
            treemacs-project-follow-cleanup        nil
            treemacs-persist-file                  (expand-file-name ".cache/treemacs-persist" user-emacs-directory)
            treemacs-position                      'left
            treemacs-recenter-distance             0.1
            treemacs-recenter-after-file-follow    nil
            treemacs-recenter-after-tag-follow     nil
            treemacs-recenter-after-project-jump   'always
            treemacs-recenter-after-project-expand 'on-distance
            treemacs-show-cursor                   nil
            treemacs-show-hidden-files             t
            treemacs-silent-filewatch              nil
            treemacs-silent-refresh                nil
            treemacs-sorting                       'alphabetic-asc
            treemacs-space-between-root-nodes      t
            treemacs-tag-follow-cleanup            t
            treemacs-tag-follow-delay              1.5
            treemacs-width                         35)

      ;; The default width and height of the icons is 22 pixels. If you are
      ;; using a Hi-DPI display, uncomment this to double the icon size.
      ;; (treemacs-resize-icons 44)

      (treemacs-follow-mode t)
      (treemacs-filewatch-mode t)
      (treemacs-fringe-indicator-mode t)
      (pcase (cons (not (null (executable-find "git")))
                   (not (null treemacs-python-executable)))
        (`(t . t)
         (treemacs-git-mode 'deferred))
        (`(t . _)
         (treemacs-git-mode 'simple))))
    :bind
    (:map global-map
          ("M-0"       . treemacs-select-window)
          ("C-x t 1"   . treemacs-delete-other-windows)
          ("C-x t t"   . treemacs)
          ("C-x t B"   . treemacs-bookmark)
          ("C-x t C-t" . treemacs-find-file)
          ("C-x t M-t" . treemacs-find-tag)))

  (use-package treemacs-evil
    :after treemacs evil)

  (use-package treemacs-magit
    :after treemacs magit)
#+END_SRC

** Time tracking

*** COMMENT Reaper

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package reaper
    :bind ("C-c h" . reaper)
    :config
    (setq reaper-api-key private/reaper-api-key
          reaper-account-id private/reaper-account-id))
#+END_SRC


** Projectile

#+BEGIN_SRC emacs-lisp :noweb-ref utils 
  (use-package projectile
    :bind-keymap ("C-c p" . projectile-command-map)
    :diminish projectile-mode
    :config
    (projectile-mode +1)
    (setq projectile-project-search-path private/projectile-project-search-path))

  (use-package helm-projectile
    :disabled nil
    :config
    (setq projectile-completion-system 'helm)
    (helm-projectile-on)
    (defvar helm-source-file-not-found
      (helm-build-dummy-source "Create file" :action 'find-file))
    (add-to-list 'helm-projectile-sources-list helm-source-file-not-found t))
#+END_SRC

** Org-roam and related

#+BEGIN_SRC emacs-lisp :noweb-ref org
  (use-package org-roam
    :after org
    :bind (("C-c n l" . org-roam-buffer-toggle)
           ("C-c n f" . org-roam-node-find)
           ("C-c n g" . org-roam-graph)
           ("C-c n i" . org-roam-node-insert)
           ("C-c n c" . org-roam-capture))
    :init
    (setq org-roam-directory private/org-roam-directory
          org-roam-v2-ack t)
    :config
    (org-roam-setup)
    (require 'org-roam-protocol))

  
  (use-package org-roam-bibtex
    :disabled nil
    :after helm-bibtex
    :config
    (org-roam-bibtex-mode)
    ;; Remove the C-c ) binding, which conflicts with RefTeX
    (eval-after-load "org-roam-bibtex"
      '(define-key org-roam-bibtex-mode-map (kbd "C-c )") nil))
    (bind-keys :map org-mode-map
               ("C-c n a" . orb-note-actions)
               :map org-roam-bibtex-mode-map
               ("C-c n a" . orb-note-actions)
               ("C-c n i" . orb-insert-link)
               ("C-c n C-f" . orb-find-note-file)))

  (use-package company-org-roam
    :config
    (push 'company-org-roam company-backends))

  (use-package websocket
    :after org-roam)

  (use-package org-roam-ui
    :straight
    (:host github :repo "org-roam/org-roam-ui" :branch "main" :files ("*.el" "out"))
    :after org-roam
    :commands org-roam-ui-mode
    :config
    (defun org-roam-ui-browse ()
      (interactive)
      (browse-url "http://127.0.0.1:35901/"))
    (bind-keys ("C-c n s" . org-roam-ui-browse))
    (add-hook 'org-roam-ui-mode-hook
              (lambda ()
                (set-process-query-on-exit-flag (get-process "httpd") nil))))

  (use-package org-roam-server
    :disabled t
    :init
    (unless (server-running-p)
      (server-start))
    (add-hook 'org-roam-server-mode-hook
              (lambda ()
                (set-process-query-on-exit-flag (get-process "httpd") nil)))
    :config
    (setq org-roam-server-host "127.0.0.1"
          org-roam-server-port 34896
          org-roam-server-authenticate nil
          org-roam-server-export-inline-images t
          org-roam-server-serve-files nil
          org-roam-server-served-file-extensions '("pdf" "mp4" "ogv")
          org-roam-server-network-poll t
          org-roam-server-network-arrows nil
          org-roam-server-network-label-truncate t
          org-roam-server-network-label-truncate-length 60
          org-roam-server-network-label-wrap-length 20)

    (defun org-roam-ui-browse ()
      (interactive)
      (browse-url "http://127.0.0.1:35901/"))

    (bind-keys :map org-roam-mode-map
               ("C-c n s" . org-roam-ui-browse))

    :hook
    (org-roam-mode . org-roam-server-mode))

  (use-package deft
    :after org
    :bind
    ("C-c n d" . deft)
    :custom
    (deft-recursive t)
    (deft-use-filter-string-for-filename t)
    (deft-strip-summary-regexp ":PROPERTIES:\n\\(.+\n\\)+:END:\n")
    (deft-default-extension "org")
    (deft-directory private/org-roam-directory))
#+END_SRC

** Subed

Subtitle editing, because that is apparently my life now

#+BEGIN_SRC emacs-lisp :noweb-ref final-packages
  (unless (boundp 'subed--init-alist)
    (defvar subed--init-alist '(("srt" . subed-srt--init)
                                ("vtt" . subed-vtt--init))
      "Alist that maps file extensions to format-specific init functions."))
  ;; trying to pre-empt some loading order problem that I don't understand

  (use-package subed
    :straight (:host github :repo "rndusr/subed" :files ("subed/*.el"))
    :mode
    ("\\.srt\\'" . subed-mode)
    :config
    (add-hook 'subed-mode-hook
              (defun my-subed-mode-hook ()
                (setq-local fill-column 40)
                (subed-disable-sync-point-to-player)
                (turn-on-auto-fill)
                (typopunct-mode)))
    :bind (:map subed-mode-map
                ("C-SPC" . subed-mpv-toggle-pause)))
#+END_SRC

** COMMENT Spotify

#+BEGIN_SRC emacs-lisp :noweb-ref utils
  (use-package mingus
    :config
    (evil-set-initial-state 'mingus-mode 'emacs)
    (evil-set-initial-state 'mingus-browser-mode 'emacs)
    (evil-set-initial-state 'mingus-playlist-mode 'emacs))
#+END_SRC

** Popwin

Manage annoying pop-up buffers

#+begin_src emacs-lisp :noweb-ref utils
  (use-package popwin
    :bind-keymap ("C-c M-p" . popwin:keymap)
    :config
    (popwin-mode 1)
    (push " *Pandoc output*" popwin:special-display-config)
    (push " *Pandoc log*" popwin:special-display-config))
#+end_src

** COMMENT Pomidor

Pomodoro for Emacs

#+begin_src emacs-lisp :noweb-ref utils
  (use-package pomidor
    :bind ("<f9>" . pomidor)
    :config
    (evil-set-initial-state 'pomidor-mode 'emacs))
#+end_src

** Other customizations

Copied from [[https://github.com/alphapapa/unpackaged.el][unpackaged.el]]

#+begin_src emacs-lisp :noweb-ref utils
  (require 'hydra)
  
  (use-package smerge-mode
    :config
    (defhydra unpackaged/smerge-hydra
      (:color pink :hint nil :post (smerge-auto-leave))
      "
  ^Move^       ^Keep^               ^Diff^                 ^Other^
  ^^-----------^^-------------------^^---------------------^^-------
  _n_ext       _b_ase               _<_: upper/base        _C_ombine
  _p_rev       _u_pper              _=_: upper/lower       _r_esolve
  ^^           _l_ower              _>_: base/lower        _k_ill current
  ^^           _a_ll                _R_efine
  ^^           _RET_: current       _E_diff
  "
      ("n" smerge-next)
      ("p" smerge-prev)
      ("b" smerge-keep-base)
      ("u" smerge-keep-upper)
      ("l" smerge-keep-lower)
      ("a" smerge-keep-all)
      ("RET" smerge-keep-current)
      ("\C-m" smerge-keep-current)
      ("<" smerge-diff-base-upper)
      ("=" smerge-diff-upper-lower)
      (">" smerge-diff-base-lower)
      ("R" smerge-refine)
      ("E" smerge-ediff)
      ("C" smerge-combine-with-next)
      ("r" smerge-resolve)
      ("k" smerge-kill-current)
      ("ZZ" (lambda ()
              (interactive)
              (save-buffer)
              (bury-buffer))
       "Save and bury buffer" :color blue)
      ("q" nil "cancel" :color blue))
    :hook (magit-diff-visit-file . (lambda ()
                                     (when smerge-mode
                                       (unpackaged/smerge-hydra/body)))))
#+end_src
** Org-noter

PDF annotation tools

#+begin_src emacs-lisp :noweb-ref utils
  (use-package org-noter
    :after org
    :config
    (setq org-noter-notes-search-path `(,private/notes-directory ".")))
#+end_src

** Screencast

#+begin_src emacs-lisp :noweb-ref utils
  (use-package gif-screencast
    :config
    (with-eval-after-load 'gif-screencast
      (define-key gif-screencast-mode-map (kbd "<f8>") 'gif-screencast-toggle-pause)
      (define-key gif-screencast-mode-map (kbd "<f9>") 'gif-screencast-stop)))
#+end_src

** Scratch

Quick scatch buffer

#+begin_src emacs-lisp :noweb-ref utils
  (use-package scratch
    :bind
    ("C-c s" . scratch))
#+end_src

* Configuration Layout

Here we define the =emacs.el= file that gets generated by the source
blocks in our Org document. This is the file that actually gets
loaded on startup. The placeholders in angled brackets correspond to
the ~noweb-ref~ arguments in the ~src~ blocks throughout this document.

#+BEGIN_SRC emacs-lisp :tangle yes :noweb no-export :exports code
  ;;; emacs.el --- Emacs configuration generated via Org Babel
  
  ;;; Commentary:
  
  ;; Do not modify this file by hand.  It was automatically generated
  ;; from `emacs.org` in the same directory.  See that file for more
  ;; information.
  
  ;;; Code:
  
  ;; Configuration group: init-before
  <<init-before>>
  
  ;; Configuration group: appearance
  <<appearance>>
  
  ;; Configuration group: evil
  <<evil>>
  
  ;; Configuration group: editing
  <<editing>>
  
  ;; Configuration group: pandoc
  <<pandoc>>
  
  ;; Configuration group: mail
  <<mail>>
  
  ;; Configuration group: org
  <<org>>
  
  ;; Configuration group: utils
  <<utils>>
  ;; Configuration group: init-after
  
  <<init-after>>
  
  ;; Configuration group: final-packages (things that seem to break so
  ;; load them last to pre-empt debug)
  <<final-packages>>
  
  ;; emacs.el ends here
#+END_SRC
